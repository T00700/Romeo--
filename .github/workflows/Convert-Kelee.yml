# https://github.com/bunizao/Mirrored/blob/main/.github/workflows/convert.yml
# https://github.com/Qmxn/Tools/blob/X/.github/workflows/SyncPlugin.yml

name: Download and Convert Kelee Plugins

on:
  schedule:
    - cron: '5,35 * * * *'  # æ¯å°æ—¶ 5 åˆ† å’Œ 35 åˆ†æ‰§è¡Œ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  process:
    runs-on: ubuntu-latest
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ä¼˜åŒ–ç‚¹1: å½»åº•ç§»é™¤äº† Python ç¯å¢ƒè®¾ç½®ã€Checkout Private Repo å’Œ Pip Install
      # å› ä¸ºä¸‹è½½å’Œæ›¿æ¢é€»è¾‘éƒ½å·²æ”¹ä¸º Bash å®ç°

      - name: Download Plugins via Mirrors
        run: |
          mkdir -p Plugin
          # å®šä¹‰é•œåƒåˆ—è¡¨
          mirrors=("https://git.botrna.site/kelee.one" "https://git.boio.me/kelee.one" "https://git.repcz.link/kelee.one")
          
          # 1. å°è¯•ä¸‹è½½ list.json
          echo "ğŸ” æ­£åœ¨å°è¯•é€šè¿‡é•œåƒè·å–æ’ä»¶åˆ—è¡¨..."
          for mirror in "${mirrors[@]}"; do
            target="$mirror/list.json"
            if curl -s -f -L "$target" -o list.json; then
              echo "âœ… æˆåŠŸä» $mirror è·å–åˆ—è¡¨"
              break
            fi
          done

          # 2. è§£æ JSON å¹¶ä¸‹è½½æ’ä»¶
          if [ -f list.json ]; then
             # æå–æ‰€æœ‰ url å­—æ®µ
             urls=$(jq -r '.. | .url? // empty' list.json)
             
             for url in $urls; do
               # å¤„ç† loon:// åè®®
               if [[ "$url" == "loon://"* ]]; then
                 clean_url=$(echo "$url" | sed 's/loon:\/\/import?plugin=//')
               else
                 clean_url="$url"
               fi
               
               filename=$(basename "$clean_url")
               if [[ "$filename" != *".plugin" ]] && [[ "$filename" != *".lpx" ]]; then
                  filename="${filename}.lpx"
               fi
               
               # å¦‚æœåŸé“¾æ¥æ˜¯ kelee.oneï¼Œæ›¿æ¢ä¸ºé•œåƒ
               if [[ "$clean_url" == *"kelee.one"* ]]; then
                 path_suffix=$(echo "$clean_url" | sed 's/https:\/\/.*kelee.one\///')
                 
                 for mirror in "${mirrors[@]}"; do
                   mirror_url="$mirror/$path_suffix"
                   echo "â¬‡ï¸ ä¸‹è½½: $filename"
                   if curl -s -L --connect-timeout 10 --retry 2 -o "Plugin/$filename" "$mirror_url"; then
                     [ -s "Plugin/$filename" ] && break
                   fi
                 done
               else
                 # é kelee.one é“¾æ¥ç›´æ¥ä¸‹è½½
                 curl -s -L -o "Plugin/$filename" "$clean_url"
               fi
             done
          else
             echo "âŒ æœªæ‰¾åˆ° list.jsonï¼Œè·³è¿‡ä¸‹è½½æ­¥éª¤ã€‚"
          fi

      - name: Move .lpx files
        run: |
          mkdir -p Modules/Loon/Kelee/Official
          # æŸ¥æ‰¾ Plugin ç›®å½•ä¸‹æ‰€æœ‰çš„æ–‡ä»¶ï¼ˆå…¼å®¹ .plugin å’Œ .lpxï¼‰ï¼Œå¹¶ç»Ÿä¸€é‡å‘½åä¸º .lpx
          find Plugin -type f \( -name '*.lpx' -o -name '*.plugin' \) | while read file; do
            filename=$(basename "$file")
            target_name="${filename%.*}.lpx"
            cp "$file" "Modules/Loon/Kelee/Official/$target_name"
          done

      # === ä¼˜åŒ–ç‚¹2: ä½¿ç”¨ Bash æ›¿ä»£ Python è„šæœ¬è¿›è¡Œ JS æå–å’Œæ›¿æ¢ ===
      - name: Find and replace external JS resources
        continue-on-error: true
        run: |
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"
          mkdir -p Modules/JS/Kelee

          # éå†åˆšåˆšç§»åŠ¨åˆ° Official ç›®å½•ä¸‹çš„æ‰€æœ‰æ’ä»¶
          find Modules/Loon/Kelee/Official -name "*.lpx" | while read plugin_file; do
            plugin_name=$(basename "$plugin_file" .lpx)
            
            # æå– http/https å¼€å¤´ï¼Œä»¥ .js, .json, .jq ç»“å°¾çš„é“¾æ¥
            # grep -v '#' å¿½ç•¥æ³¨é‡Šè¡Œ
            js_links=$(grep -v '#' "$plugin_file" | grep -oP 'https?://[^ \"\)]+\.(json|js|jq)' || echo "")

            if [ -z "$js_links" ]; then continue; fi

            echo "Processing JS for $plugin_name"

            for js_link in $js_links; do
              js_filename=$(basename "$js_link")
              local_js_path="Modules/JS/Kelee/$plugin_name/$js_filename"
              github_js_url="$js_base_url/Kelee/$plugin_name/$js_filename"
              
              mkdir -p "$(dirname "$local_js_path")"

              # ä¸‹è½½æ–‡ä»¶
              if curl -sL -A "Surge Mac/2985" --retry 2 --connect-timeout 10 -o "$local_js_path" "$js_link"; then
                # è½¬ä¹‰ URL ä¸­çš„ç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢ sed æŠ¥é”™
                escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
                
                # æ›¿æ¢æ–‡ä»¶ä¸­çš„é“¾æ¥
                sed -i "s|$escaped_link|$github_js_url|g" "$plugin_file"
                echo "  âœ… Replaced $js_filename"
              else
                echo "  âš ï¸ Failed to download $js_link"
              fi
            done
          done
      # === ä¼˜åŒ–ç»“æŸ ===

      - name: Wait for Docker services to be ready
        run: |
          echo "Waiting for Docker services to be ready..."
          timeout 60 bash -c 'until nc -z localhost 9100 && nc -z localhost 9101; do sleep 1; done'

      - name: Convert plugins (Parallelized)
        run: |
          plugin_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/Loon/Kelee/Official/"
          category="Jacob"
          encoded_category=$(echo "$category" | jq -sRr @uri)

          mkdir -p Modules/{Surge,Loon,Shadowrocket}/Kelee/Beta

          for file in Modules/Loon/Kelee/Official/*.lpx; do
            [ -f "$file" ] || continue
            filename=$(basename "$file")
            plugin_local_url="${plugin_base_url}${filename}"
            Modules_name=$(basename "$plugin_local_url" .lpx)
            encoded_Modules_name=$(echo "$Modules_name" | jq -sRr @uri)

            Surge_url="http://localhost:9100/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=surge-module&category=${encoded_category}&nore=true"
            Surge_Beta_url="http://localhost:9101/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=surge-module&category=${encoded_category}&nore=true&jqEnabled=true"
            Loon_url="http://localhost:9100/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true"
            Loon_Beta_url="http://localhost:9101/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true&jqEnabled=true"
            Shadowrocket_url="http://localhost:9100/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=shadowrocket-module&category=${encoded_category}&nore=true"
            Shadowrocket_Beta_url="http://localhost:9101/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=shadowrocket-module&category=${encoded_category}&nore=true&jqEnabled=true"

            echo "Converting ${Modules_name}..."
            
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/Kelee/${Modules_name}.sgmodule" "$Surge_url" &
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/Kelee/Beta/${Modules_name}.sgmodule" "$Surge_Beta_url" &
            
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/Kelee/${Modules_name}.lpx" "$Loon_url" &
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/Kelee/Beta/${Modules_name}.lpx" "$Loon_Beta_url" &
            
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/Kelee/${Modules_name}.srmodule" "$Shadowrocket_url" &
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/Kelee/Beta/${Modules_name}.srmodule" "$Shadowrocket_Beta_url" &
            
            wait
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"

          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

          git add Modules/*

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MESSAGE="Downloaded & Converted files at $DATE (UTC+8)"
            git commit -m "$COMMIT_MESSAGE"
            git pull --rebase --autostash || true
            git push
          fi
