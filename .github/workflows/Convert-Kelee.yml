# https://github.com/bunizao/Mirrored/blob/main/.github/workflows/convert.yml

name: Download and Convert Kelee Plugins

on:
  schedule:
    - cron: '5,35 * * * *'  # 每小时 5 分 和 35 分执行
  workflow_dispatch:

permissions:
  contents: write

jobs:
  process:
    runs-on: ubuntu-latest
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Checkout private repository
        uses: actions/checkout@v3
        with:
          repository: "${{ github.actor }}/ShalalaLala"
          token: ${{ secrets.PERSONAL_TOKENS }}
          path: ShalalaLala

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('ShalalaLala/Scripts/kelee-requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install -r ShalalaLala/Scripts/kelee-requirements.txt
          # 优化点1: 移除 apt-get，ubuntu-latest 已预装 curl, jq, netcat

      - name: Run download script
        run: python ShalalaLala/Scripts/kelee-20250807.py

      - name: List downloaded files
        run: |
          if [ -d Plugin ]; then
            ls -R Plugin
          else
            echo "⚠️ 目录不存在"
          fi

      - name: Move .lpx files
        run: |
          mkdir -p Modules/Loon/Kelee/Official
          find Plugin -name '*.lpx' | while read file; do
            cp "$file" "Modules/Loon/Kelee/Official/"
          done

      - name: Replace JS links in all plugins
        run: python3 ShalalaLala/Scripts/kelee_extract_and_replace-Romeo.py

      - name: Wait for Docker services to be ready
        run: |
          echo "Waiting for Docker services to be ready..."
          # 优化点2: 使用 timeout 防止死循环，缩短检测间隔
          timeout 60 bash -c 'until nc -z localhost 9100 && nc -z localhost 9101; do sleep 1; done'

      - name: Convert plugins (Parallelized)
        run: |
          plugin_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/Loon/Kelee/Official/"
          category="Jacob"
          encoded_category=$(echo "$category" | jq -sRr @uri)

          mkdir -p Modules/{Surge,Loon,Shadowrocket}/Kelee/Beta

          for file in Modules/Loon/Kelee/Official/*.lpx; do
            [ -f "$file" ] || continue
            filename=$(basename "$file")
            plugin_local_url="${plugin_base_url}${filename}"
            Modules_name=$(basename "$plugin_local_url" .lpx)
            encoded_Modules_name=$(echo "$Modules_name" | jq -sRr @uri)

            Surge_url="http://localhost:9100/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=surge-module&category=${encoded_category}&nore=true"
            Surge_Beta_url="http://localhost:9101/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=surge-module&category=${encoded_category}&nore=true&jqEnabled=true"
            Loon_url="http://localhost:9100/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true"
            Loon_Beta_url="http://localhost:9101/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true&jqEnabled=true"
            Shadowrocket_url="http://localhost:9100/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=shadowrocket-module&category=${encoded_category}&nore=true"
            Shadowrocket_Beta_url="http://localhost:9101/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=shadowrocket-module&category=${encoded_category}&nore=true&jqEnabled=true"

            echo "Converting ${Modules_name}..."
            
            # 优化点3: 并发执行 curl，大幅缩短转换时间
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/Kelee/${Modules_name}.sgmodule" "$Surge_url" &
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/Kelee/Beta/${Modules_name}.sgmodule" "$Surge_Beta_url" &
            
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/Kelee/${Modules_name}.lpx" "$Loon_url" &
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/Kelee/Beta/${Modules_name}.lpx" "$Loon_Beta_url" &
            
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/Kelee/${Modules_name}.srmodule" "$Shadowrocket_url" &
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/Kelee/Beta/${Modules_name}.srmodule" "$Shadowrocket_Beta_url" &
            
            wait # 等待当前文件的所有版本转换完成
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"

          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

          git add Modules/*

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MESSAGE="Downloaded & Converted files at $DATE (UTC+8)"
            # 优化 Git 提交逻辑
            git commit -m "$COMMIT_MESSAGE"
            git pull --rebase --autostash || true
            git push
          fi
