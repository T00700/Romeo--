# https://github.com/bunizao/Mirrored/blob/main/.github/workflows/convert.yml
# https://github.com/Qmxn/Tools/blob/X/.github/workflows/SyncPlugin.yml

name: Download and Convert Kelee Plugins

on:
  schedule:
    - cron: '5,35 * * * *'  # æ¯å°æ—¶ 5 åˆ† å’Œ 35 åˆ†æ‰§è¡Œ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  process:
    runs-on: ubuntu-latest
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # === é˜¶æ®µ 1: ç¯å¢ƒå‡†å¤‡ (ä¸ºäº†è¿è¡Œ cloudscraper) ===
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          # å®‰è£… cloudscraper ç”¨äºç»•è¿‡ WAF
          pip install cloudscraper requests

      # === é˜¶æ®µ 2: ä½¿ç”¨ Python + Cloudscraper ä¸‹è½½æ’ä»¶ ===
      - name: Download Plugins (Python script)
        run: |
          # åˆ›å»º Python è„šæœ¬æ¥å¤„ç†ä¸‹è½½
          cat <<EOF > download_kelee.py
          import os
          import json
          import cloudscraper
          from urllib.parse import urlparse

          # é…ç½®
          LIST_URL = "https://pluginhub.kelee.one/list.json"
          OUTPUT_DIR = "Plugin"
          
          # åˆå§‹åŒ– scraper (æ¨¡æ‹Ÿæµè§ˆå™¨ç»•è¿‡ Cloudflare)
          scraper = cloudscraper.create_scraper(
              browser={
                  'browser': 'chrome',
                  'platform': 'ios',
                  'desktop': False
              }
          )

          def download_plugins():
              if not os.path.exists(OUTPUT_DIR):
                  os.makedirs(OUTPUT_DIR)

              print(f"ğŸ” æ­£åœ¨è·å–æ’ä»¶åˆ—è¡¨: {LIST_URL}")
              try:
                  resp = scraper.get(LIST_URL)
                  if resp.status_code != 200:
                      print(f"âŒ è·å–åˆ—è¡¨å¤±è´¥: {resp.status_code}")
                      return
                  
                  data = resp.json()
                  plugins = data.get("lists", [])
                  print(f"âœ… è·å–æˆåŠŸï¼Œå…±æœ‰ {len(plugins)} ä¸ªæ’ä»¶")

                  for item in plugins:
                      raw_url = item.get("url", "")
                      if not raw_url:
                          continue

                      # æ¸…ç† URL: å»æ‰ loon://import?plugin=
                      download_url = raw_url.replace("loon://import?plugin=", "")
                      
                      # æå–æ–‡ä»¶å
                      path = urlparse(download_url).path
                      filename = os.path.basename(path)
                      if not filename.endswith(".lpx") and not filename.endswith(".plugin"):
                          filename += ".lpx"

                      save_path = os.path.join(OUTPUT_DIR, filename)
                      
                      print(f"â¬‡ï¸ æ­£åœ¨ä¸‹è½½: {filename}")
                      try:
                          # ä½¿ç”¨ scraper ä¸‹è½½å…·ä½“æ–‡ä»¶ï¼Œé˜²æ­¢æ–‡ä»¶ä¸‹è½½ä¹Ÿè¢«æ‹¦æˆª
                          file_resp = scraper.get(download_url)
                          if file_resp.status_code == 200:
                              with open(save_path, 'wb') as f:
                                  f.write(file_resp.content)
                              print(f"  âœ… ä¿å­˜æˆåŠŸ")
                          else:
                              print(f"  âŒ ä¸‹è½½å¤±è´¥: {file_resp.status_code}")
                      except Exception as e:
                          print(f"  âš ï¸ ä¸‹è½½å¼‚å¸¸: {e}")

              except Exception as e:
                  print(f"âŒ ä¸¥é‡é”™è¯¯: {e}")

          if __name__ == "__main__":
              download_plugins()
          EOF
          
          # è¿è¡Œè„šæœ¬
          python download_kelee.py

      # === é˜¶æ®µ 3: å›å½’ä½ åŸæ¥çš„ Bash é€»è¾‘å¤„ç†æ–‡ä»¶ ===
      
      - name: Move .lpx files
        run: |
          mkdir -p Modules/Loon/Kelee/Official
          # æŸ¥æ‰¾ Plugin ç›®å½•ä¸‹æ‰€æœ‰çš„æ–‡ä»¶
          find Plugin -type f \( -name '*.lpx' -o -name '*.plugin' \) | while read file; do
            filename=$(basename "$file")
            target_name="${filename%.*}.lpx"
            cp "$file" "Modules/Loon/Kelee/Official/$target_name"
          done

      - name: Replace JS links in all plugins (Bash)
        continue-on-error: true
        run: |
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"
          mkdir -p Modules/JS/Kelee
          
          # ä½¿ç”¨ Cloudscraper ä¸‹è½½ JS æ¯”è¾ƒéº»çƒ¦ï¼Œè¿™é‡Œ JS ä¸€èˆ¬å­˜æ”¾åœ¨ Github Raw æˆ–å…¶ä»– CDNï¼Œ
          # é€šå¸¸ curl å°±èƒ½æå®šã€‚å¦‚æœ JS ä¹Ÿåœ¨ kelee.oneï¼Œå¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œ
          # ä½†ä¸€èˆ¬æ’ä»¶å¼•ç”¨çš„ JS éƒ½æ˜¯å¤–éƒ¨çš„ã€‚
          
          find Modules/Loon/Kelee/Official -name "*.lpx" | while read plugin_file; do
            plugin_name=$(basename "$plugin_file" .lpx)
            
            js_links=$(grep -v '#' "$plugin_file" | grep -oP 'https?://[^ \"\)]+\.(json|js|jq)' || echo "")

            if [ -z "$js_links" ]; then continue; fi
            echo "Processing JS for $plugin_name"

            for js_link in $js_links; do
              js_filename=$(basename "$js_link")
              local_js_path="Modules/JS/Kelee/$plugin_name/$js_filename"
              github_js_url="$js_base_url/Kelee/$plugin_name/$js_filename"
              
              mkdir -p "$(dirname "$local_js_path")"

              # JS ä¸‹è½½å°è¯• curl (å¸¦ UA)
              if curl -sL -A "Surge Mac/2985" --retry 2 --connect-timeout 10 -o "$local_js_path" "$js_link"; then
                escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
                sed -i "s|$escaped_link|$github_js_url|g" "$plugin_file"
                echo "  âœ… Replaced $js_filename"
              else
                echo "  âš ï¸ Failed to download JS: $js_link"
              fi
            done
          done

      - name: Wait for Docker services to be ready
        run: |
          echo "Waiting for Docker services to be ready..."
          timeout 60 bash -c 'until nc -z localhost 9100 && nc -z localhost 9101; do sleep 1; done'

      - name: Convert plugins (Parallelized)
        run: |
          plugin_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/Loon/Kelee/Official/"
          category="Jacob"
          encoded_category=$(echo "$category" | jq -sRr @uri)

          mkdir -p Modules/{Surge,Loon,Shadowrocket}/Kelee/Beta

          for file in Modules/Loon/Kelee/Official/*.lpx; do
            [ -f "$file" ] || continue
            filename=$(basename "$file")
            plugin_local_url="${plugin_base_url}${filename}"
            Modules_name=$(basename "$plugin_local_url" .lpx)
            encoded_Modules_name=$(echo "$Modules_name" | jq -sRr @uri)

            Surge_url="http://localhost:9100/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=surge-module&category=${encoded_category}&nore=true"
            Surge_Beta_url="http://localhost:9101/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=surge-module&category=${encoded_category}&nore=true&jqEnabled=true"
            Loon_url="http://localhost:9100/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true"
            Loon_Beta_url="http://localhost:9101/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true&jqEnabled=true"
            Shadowrocket_url="http://localhost:9100/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=shadowrocket-module&category=${encoded_category}&nore=true"
            Shadowrocket_Beta_url="http://localhost:9101/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=shadowrocket-module&category=${encoded_category}&nore=true&jqEnabled=true"

            echo "Converting ${Modules_name}..."
            
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/Kelee/${Modules_name}.sgmodule" "$Surge_url" &
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/Kelee/Beta/${Modules_name}.sgmodule" "$Surge_Beta_url" &
            
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/Kelee/${Modules_name}.lpx" "$Loon_url" &
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/Kelee/Beta/${Modules_name}.lpx" "$Loon_Beta_url" &
            
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/Kelee/${Modules_name}.srmodule" "$Shadowrocket_url" &
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/Kelee/Beta/${Modules_name}.srmodule" "$Shadowrocket_Beta_url" &
            
            wait
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"

          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

          git add Modules/*

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MESSAGE="Downloaded & Converted files at $DATE (UTC+8)"
            git commit -m "$COMMIT_MESSAGE"
            git pull --rebase --autostash || true
            git push
          fi
