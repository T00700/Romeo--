# https://github.com/bunizao/Mirrored/blob/main/.github/workflows/convert.yml
# https://github.com/Qmxn/Tools/blob/X/.github/workflows/SyncPlugin.yml

name: Download and Convert Kelee Plugins

on:
  schedule:
    - cron: '5,35 * * * *'  # æ¯å°æ—¶ 5 åˆ† å’Œ 35 åˆ†æ‰§è¡Œ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  process:
    runs-on: ubuntu-latest
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # æ­¥éª¤1: ä¸‹è½½æ’ä»¶ (æ ¸å¿ƒä¿®æ”¹)
      - name: Download Plugins via Bash
        run: |
          mkdir -p Plugin
          
          # 1. å®šä¹‰ä¼ªè£…å¤´å’Œé•œåƒæº
          UA="Loon/3.2.1 (iPhone; iOS 17.2; Scale/3.00)"
          mirrors=("https://git.botrna.site" "https://git.boio.me" "https://git.repcz.link")
          JSON_URL="https://pluginhub.kelee.one/list.json"
          
          echo "ğŸ” æ­£åœ¨è·å–æ’ä»¶åˆ—è¡¨: $JSON_URL"
          
          # 2. ä¸‹è½½ list.json (ä¼˜å…ˆç›´è¿ï¼Œå¸¦UA)
          # -L è·Ÿéšé‡å®šå‘, -f å¤±è´¥ä¸è¾“å‡ºå†…å®¹
          if ! curl -s -L -H "User-Agent: $UA" -o list.json "$JSON_URL"; then
            echo "âš ï¸ ç›´è¿è·å–åˆ—è¡¨å¤±è´¥ï¼Œå°è¯•é•œåƒ..."
            for mirror in "${mirrors[@]}"; do
              # å°è¯•æ‹¼æ¥é•œåƒè·¯å¾„ï¼Œå‡è®¾é•œåƒä»£ç†äº† kelee.one
              # æ³¨æ„ï¼šå…·ä½“é•œåƒè·¯å¾„è§„åˆ™å–å†³äºé•œåƒç«™ï¼Œè¿™é‡Œå‚è€ƒä½ æä¾›çš„ successful script é€»è¾‘
              mirror_json_url="$mirror/kelee.one/list.json"
              if curl -s -L -H "User-Agent: $UA" -o list.json "$mirror_json_url"; then
                echo "âœ… é€šè¿‡é•œåƒè·å–åˆ—è¡¨æˆåŠŸ: $mirror"
                break
              fi
            done
          fi

          if [ ! -s list.json ]; then
            echo "âŒ æ— æ³•è·å–æœ‰æ•ˆçš„ list.jsonï¼Œæµç¨‹ç»ˆæ­¢ã€‚"
            exit 1
          fi

          # 3. è§£æ JSON å¹¶ä¸‹è½½ (jqæå– lists ä¸­çš„ url)
          # æå–é€»è¾‘ï¼šæ‰¾åˆ° lists æ•°ç»„ -> å–å‡º url å­—æ®µ -> å»æ‰ loon://import?plugin= å‰ç¼€
          urls=$(jq -r '.lists[].url' list.json | sed 's/loon:\/\/import?plugin=//')
          
          echo "ğŸ“¦ æ‰¾åˆ°æ’ä»¶é“¾æ¥ï¼Œå‡†å¤‡ä¸‹è½½..."
          
          count=0
          for url in $urls; do
            # æå–æ–‡ä»¶å
            filename=$(basename "$url")
            # ç¡®ä¿åç¼€åä¸º .lpx
            if [[ "$filename" != *".lpx" ]]; then filename="${filename}.lpx"; fi
            
            echo "â¬‡ï¸ æ­£åœ¨å¤„ç†: $filename"
            
            # å°è¯•ä¸‹è½½é€»è¾‘å‡½æ•°
            download_file() {
              local target_url="$1"
              local output_file="Plugin/$2"
              
              # å°è¯• 1: ç›´è¿ä¸‹è½½ (å¸¦ UA)
              if curl -s -L --connect-timeout 10 --retry 2 -H "User-Agent: $UA" -o "$output_file" "$target_url"; then
                 # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©ºæˆ–åŒ…å« HTML é”™è¯¯é¡µ
                 if [ -s "$output_file" ] && ! grep -q "<html" "$output_file"; then
                   echo "  âœ… ç›´è¿ä¸‹è½½æˆåŠŸ"
                   return 0
                 fi
              fi
              
              # å°è¯• 2: é•œåƒä¸‹è½½ (å¦‚æœ URL åŒ…å« kelee.one)
              if [[ "$target_url" == *"kelee.one"* ]]; then
                # æ„é€ é•œåƒ URL: å°† https://kelee.one æ›¿æ¢ä¸º https://mirror/kelee.one
                local path_part=$(echo "$target_url" | sed 's/^https:\/\/kelee.one\///')
                
                for mirror in "${mirrors[@]}"; do
                  local mirror_url="$mirror/kelee.one/$path_part"
                  echo "  âš ï¸ ç›´è¿å¤±è´¥ï¼Œå°è¯•é•œåƒ: $mirror"
                  if curl -s -L --connect-timeout 10 --retry 2 -H "User-Agent: $UA" -o "$output_file" "$mirror_url"; then
                    if [ -s "$output_file" ] && ! grep -q "<html" "$output_file"; then
                      echo "  âœ… é•œåƒä¸‹è½½æˆåŠŸ"
                      return 0
                    fi
                  fi
                done
              fi
              
              echo "  âŒ æ‰€æœ‰æ–¹å¼ä¸‹è½½å¤±è´¥"
              return 1
            }
            
            download_file "$url" "$filename"
            count=$((count+1))
          done
          
          echo "ğŸ‰ å¤„ç†å®Œæˆï¼Œå…±å¤„ç† $count ä¸ªæ’ä»¶ã€‚"

      # æ­¥éª¤2: ç§»åŠ¨æ–‡ä»¶åˆ°æŒ‡å®šç›®å½• (ä¿æŒåŸæœ‰é€»è¾‘)
      - name: Move .lpx files
        run: |
          mkdir -p Modules/Loon/Kelee/Official
          # æŸ¥æ‰¾ä¸‹è½½çš„æ–‡ä»¶å¹¶ç§»åŠ¨
          find Plugin -type f -name '*.lpx' | while read file; do
            cp "$file" "Modules/Loon/Kelee/Official/"
          done

      # æ­¥éª¤3: æ›¿æ¢ JS é“¾æ¥ (Bashç‰ˆï¼Œæ›¿ä»£ Python è„šæœ¬)
      - name: Find and replace external JS resources
        continue-on-error: true
        run: |
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"
          mkdir -p Modules/JS/Kelee

          # ä¼ªè£… UA é˜²æ­¢ä¸‹è½½ JS æ—¶ä¹Ÿè¢«æ‹¦æˆª
          UA="Loon/3.2.1 (iPhone; iOS 17.2; Scale/3.00)"

          find Modules/Loon/Kelee/Official -name "*.lpx" | while read plugin_file; do
            plugin_name=$(basename "$plugin_file" .lpx)
            
            # æå– http/https é“¾æ¥ (js/json/jq)
            js_links=$(grep -v '#' "$plugin_file" | grep -oP 'https?://[^ \"\)]+\.(json|js|jq)' || echo "")

            if [ -z "$js_links" ]; then continue; fi
            
            echo "Processing JS for $plugin_name"

            for js_link in $js_links; do
              js_filename=$(basename "$js_link")
              local_js_path="Modules/JS/Kelee/$plugin_name/$js_filename"
              github_js_url="$js_base_url/Kelee/$plugin_name/$js_filename"
              
              mkdir -p "$(dirname "$local_js_path")"

              # ä¸‹è½½ JS (åŒæ ·åŠ ä¸Š UA)
              if curl -sL -H "User-Agent: $UA" --retry 2 --connect-timeout 10 -o "$local_js_path" "$js_link"; then
                escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
                sed -i "s|$escaped_link|$github_js_url|g" "$plugin_file"
                echo "  âœ… Replaced $js_filename"
              else
                echo "  âš ï¸ Failed to download JS: $js_link"
              fi
            done
          done

      - name: Wait for Docker services to be ready
        run: |
          echo "Waiting for Docker services to be ready..."
          timeout 60 bash -c 'until nc -z localhost 9100 && nc -z localhost 9101; do sleep 1; done'

      # æ­¥éª¤4: å¹¶å‘è½¬æ¢ (ä¿æŒä¹‹å‰çš„ä¼˜åŒ–)
      - name: Convert plugins (Parallelized)
        run: |
          plugin_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/Loon/Kelee/Official/"
          category="Jacob"
          encoded_category=$(echo "$category" | jq -sRr @uri)

          mkdir -p Modules/{Surge,Loon,Shadowrocket}/Kelee/Beta

          for file in Modules/Loon/Kelee/Official/*.lpx; do
            [ -f "$file" ] || continue
            filename=$(basename "$file")
            plugin_local_url="${plugin_base_url}${filename}"
            Modules_name=$(basename "$plugin_local_url" .lpx)
            encoded_Modules_name=$(echo "$Modules_name" | jq -sRr @uri)

            Surge_url="http://localhost:9100/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=surge-module&category=${encoded_category}&nore=true"
            Surge_Beta_url="http://localhost:9101/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=surge-module&category=${encoded_category}&nore=true&jqEnabled=true"
            Loon_url="http://localhost:9100/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true"
            Loon_Beta_url="http://localhost:9101/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true&jqEnabled=true"
            Shadowrocket_url="http://localhost:9100/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=shadowrocket-module&category=${encoded_category}&nore=true"
            Shadowrocket_Beta_url="http://localhost:9101/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=shadowrocket-module&category=${encoded_category}&nore=true&jqEnabled=true"

            echo "Converting ${Modules_name}..."
            
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/Kelee/${Modules_name}.sgmodule" "$Surge_url" &
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/Kelee/Beta/${Modules_name}.sgmodule" "$Surge_Beta_url" &
            
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/Kelee/${Modules_name}.lpx" "$Loon_url" &
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/Kelee/Beta/${Modules_name}.lpx" "$Loon_Beta_url" &
            
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/Kelee/${Modules_name}.srmodule" "$Shadowrocket_url" &
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/Kelee/Beta/${Modules_name}.srmodule" "$Shadowrocket_Beta_url" &
            
            wait
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"

          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

          git add Modules/*

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MESSAGE="Downloaded & Converted files at $DATE (UTC+8)"
            git commit -m "$COMMIT_MESSAGE"
            git pull --rebase --autostash || true
            git push
          fi
