# https://github.com/bunizao/Mirrored/blob/main/.github/workflows/convert.yml
# https://github.com/Qmxn/Tools/blob/X/.github/workflows/SyncPlugin.yml

name: Download and Convert Kelee Plugins

on:
  schedule:
    - cron: '5,35 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  process:
    runs-on: ubuntu-latest
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # === 1. ÁéØÂ¢ÉÂáÜÂ§á ===
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Checkout private repository
        uses: actions/checkout@v4
        with:
          repository: "${{ github.actor }}/ShalalaLala"
          token: ${{ secrets.PERSONAL_TOKENS }}
          path: ShalalaLala
          sparse-checkout: |
            Scripts/kelee-20251120.py

      - name: Install dependencies
        run: pip install cloudscraper requests

      # === 2. Ëé∑Âèñ‰∏ãËΩΩÈìæÊé• (‰ΩøÁî®ËøúÁ®ã Python ËÑöÊú¨) ===
      - name: Generate Plugin.txt
        run: python ShalalaLala/Scripts/kelee-20251120.py

      # === 3. ‰ΩøÁî®ÈïúÂÉèÂπ∂Âèë‰∏ãËΩΩ (Êú¨Âú∞ Bash) ===
      - name: Download Plugins via Mirrors
        run: |
          mkdir -p Plugin
          Plugin_FILE_PATH="Plugin.txt"

          if [ ! -f "$Plugin_FILE_PATH" ]; then
            echo "‚ùå Error: Plugin.txt not found."
            exit 1
          fi

          mirrors=("git.botrna.site" "git.boio.me" "git.repcz.link")
          UA="Loon/3.2.1 (iPhone; iOS 17.2; Scale/3.00)"

          echo "üì• Starting download process..."

          while IFS= read -r url; do
            [ -z "$url" ] && continue
            
            filename=$(basename "${url%%\?*}")
            if [[ "$filename" != *".lpx" ]] && [[ "$filename" != *".plugin" ]]; then
               filename="${filename}.lpx"
            fi
            
            output_path="Plugin/$filename"
            download_success=false
            
            echo "‚ö° Processing: $filename"

            if [[ "$url" == *"kelee.one"* ]]; then
              for mirror in "${mirrors[@]}"; do
                mirror_url="${url/https:\/\/kelee.one/https:\/\/$mirror/kelee.one}"
                if curl -s -L -f --connect-timeout 10 --retry 2 -H "User-Agent: $UA" -o "$output_path" "$mirror_url"; then
                  if [ -s "$output_path" ]; then
                    echo "  ‚úÖ Downloaded via $mirror"
                    download_success=true
                    break
                  fi
                fi
              done
            else
              if curl -s -L -f --connect-timeout 10 --retry 2 -H "User-Agent: $UA" -o "$output_path" "$url"; then
                 [ -s "$output_path" ] && download_success=true
                 echo "  ‚úÖ Downloaded direct"
              fi
            fi
            
            if [ "$download_success" = false ]; then
              echo "  ‚ùå Failed to download: $filename"
            fi
          done < "$Plugin_FILE_PATH"

      # === 4. ÁßªÂä®Êñá‰ª∂ ===
      - name: Move .lpx files
        run: |
          mkdir -p Modules/Loon/Kelee/Official
          if [ -d "Plugin" ]; then
            find Plugin -type f \( -name '*.lpx' -o -name '*.plugin' \) | while read file; do
              filename=$(basename "$file")
              target_name="${filename%.*}.lpx"
              cp "$file" "Modules/Loon/Kelee/Official/$target_name"
            done
          fi

      # === 5. Á≠âÂæÖ Docker ===
      - name: Wait for Docker services to be ready
        run: |
          echo "Waiting for Docker services..."
          timeout 60 bash -c 'until nc -z localhost 9100 && nc -z localhost 9101; do sleep 1; done'

      # === 6. ‰∏≤Ë°åËΩ¨Êç¢ (Serialized Convert) ===
      - name: Convert plugins (Serialized for Stability)
        run: |
          plugin_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/Loon/Kelee/Official/"
          category="Jacob"
          encoded_category=$(echo "$category" | jq -sRr @uri)

          mkdir -p Modules/{Surge,Loon,Shadowrocket}/Kelee/Beta

          for file in Modules/Loon/Kelee/Official/*.lpx; do
            [ -f "$file" ] || continue
            filename=$(basename "$file")
            plugin_local_url="${plugin_base_url}${filename}"
            Modules_name=$(basename "$plugin_local_url" .lpx)
            encoded_Modules_name=$(echo "$Modules_name" | jq -sRr @uri)

            Surge_url="http://localhost:9100/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=surge-module&category=${encoded_category}&nore=true"
            Surge_Beta_url="http://localhost:9101/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=surge-module&category=${encoded_category}&nore=true&jqEnabled=true"
            Loon_url="http://localhost:9100/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true"
            Loon_Beta_url="http://localhost:9101/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true&jqEnabled=true"
            Shadowrocket_url="http://localhost:9100/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.srmodule?type=loon-plugin&target=shadowrocket-module&category=${encoded_category}&nore=true"
            Shadowrocket_Beta_url="http://localhost:9101/file/_start_/${plugin_local_url}/_end_/${encoded_Modules_name}.srmodule?type=loon-plugin&target=shadowrocket-module&category=${encoded_category}&nore=true&jqEnabled=true"

            echo "Converting ${Modules_name}..."
            
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/Kelee/${Modules_name}.sgmodule" "$Surge_url" || echo "Failed Surge"
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/Kelee/Beta/${Modules_name}.sgmodule" "$Surge_Beta_url" || echo "Failed Surge Beta"
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/Kelee/${Modules_name}.lpx" "$Loon_url" || echo "Failed Loon"
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/Kelee/Beta/${Modules_name}.lpx" "$Loon_Beta_url" || echo "Failed Loon Beta"
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/Kelee/${Modules_name}.srmodule" "$Shadowrocket_url" || echo "Failed Shadowrocket"
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/Kelee/Beta/${Modules_name}.srmodule" "$Shadowrocket_Beta_url" || echo "Failed Shadowrocket Beta"
          done

      # === 7. JS ËµÑÊ∫êÊèêÂèñ‰∏éÊõøÊç¢ (Â∫îÁî®ÈïúÂÉèÈÄªËæë + ÂÖ®ËåÉÂõ¥ÊèêÂèñ) ===
      - name: Find and replace external JS resources
        continue-on-error: true
        run: |
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"
          mkdir -p Modules/JS/Kelee
          mirrors=("git.botrna.site" "git.boio.me" "git.repcz.link")
          UA="Loon/3.2.1 (iPhone; iOS 17.2; Scale/3.00)"

          # Ê†∏ÂøÉ‰øÆÊ≠£ÔºöÊü•Êâæ Official ÁõÆÂΩï‰∏ãÁöÑÊâÄÊúâ .lpx Êñá‰ª∂
          find Modules/Loon/Kelee/Official -name "*.lpx" | while read plugin_file; do
            plugin_name=$(basename "$plugin_file" .lpx)
            
            # Ê†∏ÂøÉ‰øÆÊ≠£ÔºöÊèêÂèñÊâÄÊúâ http...js ÈìæÊé•
            js_links=$(grep -v '#' "$plugin_file" | grep -oP 'https?://[^ \"\)]+\.(json|js|jq)' || echo "")

            if [ -z "$js_links" ]; then continue; fi
            echo "Processing JS for $plugin_name"

            for js_link in $js_links; do
              js_filename=$(basename "$js_link")
              local_js_path="Modules/JS/Kelee/$plugin_name/$js_filename"
              github_js_url="$js_base_url/Kelee/$plugin_name/$js_filename"
              
              mkdir -p "$(dirname "$local_js_path")"
              download_success=false

              # ÈïúÂÉè‰∏ãËΩΩÈÄªËæë
              if [[ "$js_link" == *"kelee.one"* ]]; then
                for mirror in "${mirrors[@]}"; do
                  mirror_url="${js_link/https:\/\/kelee.one/https:\/\/$mirror/kelee.one}"
                  if curl -s -L -f --connect-timeout 10 --retry 2 -H "User-Agent: $UA" -o "$local_js_path" "$mirror_url"; then
                    if [ -s "$local_js_path" ]; then
                       echo "  ‚úÖ JS Downloaded via $mirror: $js_filename"
                       download_success=true
                       break
                    fi
                  fi
                done
              else
                if curl -s -L -f --connect-timeout 10 --retry 2 -H "User-Agent: $UA" -o "$local_js_path" "$js_link"; then
                   if [ -s "$local_js_path" ]; then
                      echo "  ‚úÖ JS Downloaded direct: $js_filename"
                      download_success=true
                   fi
                fi
              fi

              # ÊâπÈáèÊõøÊç¢ÈÄªËæë
              if [ "$download_success" = true ]; then
                escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
                find Modules -name "${plugin_name}.sgmodule" -o -name "${plugin_name}.lpx" -o -name "${plugin_name}.srmodule" | \
                xargs -I {} sed -i "s|$escaped_link|$github_js_url|g" "{}"
                echo "  üîÑ Replaced link in modules"
              else
                echo "  ‚ö†Ô∏è Failed to download JS: $js_link"
              fi
            done
          done

      # === 8. Êèê‰∫§Êõ¥Êîπ ===
      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"

          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

          git add Modules/*

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MESSAGE="Downloaded & Converted files at $DATE (UTC+8)"
            git commit -m "$COMMIT_MESSAGE"
            git pull --rebase --autostash || true
            git push
          fi
