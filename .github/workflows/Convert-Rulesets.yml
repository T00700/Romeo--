name: Extract and Process Rulesets

on:
  schedule:
    - cron: '0,30 * * * *'
  workflow_dispatch:

jobs:
  Converting:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      # ä¼˜åŒ–ç‚¹1: ç§»é™¤ apt-getï¼Œubuntu-latest å·²é¢„è£… curl, jq, netcat

      - name: Wait for Docker services to be ready
        run: |
          echo "Waiting for Docker services to be ready..."
          # ä¼˜åŒ–ç‚¹2: ä½¿ç”¨ timeout é˜²æ­¢æ­»å¾ªç¯ï¼Œç¼©çŸ­æ£€æµ‹é—´éš”
          timeout 60 bash -c 'until nc -z localhost 9100 && nc -z localhost 9101; do sleep 1; done'

      - name: Process Links and Download Files
        run: |
          # å¤„ç†æ¯ä¸ªé“¾æ¥
          while read -r Ruleset_link; do
            # è·³è¿‡æ³¨é‡Šè¡Œå’Œç©ºç™½è¡Œ
            if [[ "$Ruleset_link" =~ ^\s*#.* ]] || [[ -z "${Ruleset_link// }" ]]; then
              continue
            fi
            
            # ç‰¹æ®ŠURL ğŸ˜‚ å¤„ç†
            encoded_module_link=$(echo "$Ruleset_link" | sed 's/ğŸ˜‚/%F0%9F%98%82/g')

            # è·å–ä½œè€…å
            author=$(echo "$Ruleset_link" | cut -d'/' -f4)
            filename_noext=$(basename "$Ruleset_link" | sed 's/\(.*\)\..*/\1/')
            encoded_filename=$(echo "$filename_noext" | jq -sRr @uri)
            
            # åˆ›å»ºæ–‡ä»¶å¤¹ (ä¿æŒåŸé€»è¾‘)
            echo "Processing $filename_noext by $author..."
            mkdir -p Rulesets/{Surge,Loon,Shadowrocket,Clash}/$author/Beta

            # æ„å»ºæ¨¡å—çš„ URL (å®Œå…¨ä¿æŒåŸå‚æ•°)
            Surge_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.list?type=rule-set&target=surge-rule-set&nore=true"
            Surge_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.list?type=rule-set&target=surge-rule-set&nore=true&jqEnabled=true"
            Loon_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.lsr?type=rule-set&target=loon-rule-set&icon=Loon&nore=true"
            Loon_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.lsr?type=rule-set&target=loon-rule-set&icon=Loon&nore=true&jqEnabled=true"
            Shadowrocket_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.list?type=rule-set&target=shadowrocket-rule-set&nore=true"
            Shadowrocket_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.list?type=rule-set&target=shadowrocket-rule-set&nore=true&jqEnabled=true"
            Clash_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.yaml?type=rule-set&target=stash-rule-set&nore=true"
            Clash_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.yaml?type=rule-set&target=stash-rule-set&nore=true&jqEnabled=true"

            # ä¸‹è½½å„æ¨¡å—æ–‡ä»¶ (ä¼˜åŒ–ç‚¹3: ä½¿ç”¨ & åå°ä¸‹è½½ï¼Œç„¶å wait ç­‰å¾…è¿™ä¸€ç»„å®Œæˆ)
            # è¿™æ ·æ—¢æé€Ÿäº†ï¼Œåˆä¿è¯äº†å¤„ç†æµç¨‹å’ŒåŸç‰ˆå®Œå…¨ä¸€è‡´ï¼ˆæŒ‰é“¾æ¥é¡ºåºå¤„ç†ï¼‰
            
            curl -A "Surge Mac/2985" -L -o "Rulesets/Surge/$author/$filename_noext.list" "$Surge_url" &
            curl -A "Surge Mac/2985" -L -o "Rulesets/Surge/$author/Beta/$filename_noext.list" "$Surge_Beta_url" &

            curl -A "Surge Mac/2985" -L -o "Rulesets/Loon/$author/$filename_noext.lsr" "$Loon_url" &
            curl -A "Surge Mac/2985" -L -o "Rulesets/Loon/$author/Beta/$filename_noext.lsr" "$Loon_Beta_url" &

            curl -A "Surge Mac/2985" -L -o "Rulesets/Shadowrocket/$author/$filename_noext.list" "$Shadowrocket_url" &
            curl -A "Surge Mac/2985" -L -o "Rulesets/Shadowrocket/$author/Beta/$filename_noext.list" "$Shadowrocket_Beta_url" &

            curl -A "Surge Mac/2985" -L -o "Rulesets/Clash/$author/$filename_noext.yaml" "$Clash_url" &
            curl -A "Surge Mac/2985" -L -o "Rulesets/Clash/$author/Beta/$filename_noext.yaml" "$Clash_Beta_url" &
            
            # å…³é”®ï¼šç­‰å¾…å½“å‰è¿™ 8 ä¸ªæ–‡ä»¶ä¸‹è½½å®Œæ¯•ï¼Œå†è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯è¯»å–ä¸‹ä¸€ä¸ªé“¾æ¥
            wait 
          done < Links/Rulesets-Links.txt

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–å½“å‰æ—¥æœŸï¼Œè®¾ç½®ä¸ºåŒ—äº¬æ—¶é—´ (UTC+8)
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹
          git add Rulesets/*
          
          # å¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            # æäº¤æ¶ˆæ¯ï¼ŒåŒ…å«åŠ¨æ€çš„æ—¥æœŸ
            COMMIT_MESSAGE="Converted Rulesets at $DATE (UTC+8)"
            
            # ç¡®ä¿ä»“åº“æ˜¯æœ€æ–°çš„ï¼Œé¿å…å†²çª
            git stash
            git pull --rebase  # åŒæ­¥è¿œç¨‹ä»“åº“çš„æœ€æ–°æ›´æ”¹
            git stash pop || true # æ¢å¤ä¹‹å‰çš„æ›´æ”¹
            
            # å†æ¬¡æ·»åŠ æ–‡ä»¶ï¼Œè¿›è¡Œæäº¤
            git add Rulesets/*
            git commit -m "$COMMIT_MESSAGE"
            git push
          fi
