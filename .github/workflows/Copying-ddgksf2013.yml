name: Mirror ddgksf2013 Modules

on:
  schedule:
    - cron: '15 */12 * * *'
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  Author: ddgksf2013

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    services:
      docker:
        image: xream/script-hub:latest
        ports: [9100:9100, 9101:9101]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      - name: Wait for Docker service
        run: |
          echo "Waiting for Docker..."
          timeout 60 bash -c 'until nc -z localhost 9100 && nc -z localhost 9101; do sleep 1; done'

      - name: Download README & Extract Real URLs
        run: |
          # 1. ä¸‹è½½ README
          curl -sL "https://raw.githubusercontent.com/ddgksf2013/ddgksf2013/main/README.md" -o README.md
          
          # 2. ä½¿ç”¨ Python æå–å¹¶è§£ç  URL
          # å¤„ç†é€»è¾‘ï¼š
          # a. å¯»æ‰¾æ‰€æœ‰ href é‡Œçš„é“¾æ¥
          # b. å¦‚æœæ˜¯åŒ…å« remote-resource çš„ QuanX é“¾æ¥ï¼Œåˆ™è¿›è¡Œ URL è§£ç å¹¶æå–å‡ºçœŸå®çš„ http(s) åœ°å€
          # c. å¦‚æœæ˜¯æ™®é€šçš„ .conf, .js ç­‰é“¾æ¥ï¼Œç›´æ¥ä¿ç•™
          python3 -c "
          import re, urllib.parse, sys
          with open('README.md', 'r', encoding='utf-8') as f:
              content = f.read()
          links = re.findall(r'href=\"([^\"]+)\"', content)
          urls = set()
          for link in links:
              if 'remote-resource=' in link:
                  decoded = urllib.parse.unquote(link)
                  # åŒ¹é…ä»¥ http å¼€å¤´ï¼Œåˆ°ç¬¬ä¸€ä¸ªé€—å·ã€åŒå¼•å·æˆ–ç©ºæ ¼ç»“æŸçš„éƒ¨åˆ†
                  real_url = re.search(r'(https?://[^\s,\"]+)', decoded)
                  if real_url:
                      urls.add(real_url.group(1))
              elif any(link.endswith(ext) for ext in ['.sgmodule', '.snippet', '.conf', '.js']):
                  urls.add(link)
          for u in sorted(list(urls)):
              print(u)
          " > plugin_urls.txt

          echo "âœ… Extracted URLs:"
          cat plugin_urls.txt

      - name: Process files (Serialized for Stability)
        run: |
          category="Jacob"
          encoded_category=$(echo "$category" | jq -sRr @uri)
          
          mkdir -p Modules/{Surge,Loon,Shadowrocket}/${Author}/Beta

          while read -r plugin_url; do
            # è·³è¿‡ç©ºè¡Œ
            [ -z "$plugin_url" ] && continue

            filename=$(basename "$plugin_url")
            # ç§»é™¤æŸ¥è¯¢å‚æ•°
            filename="${filename%%\?*}"
            Modules_name="${filename%.*}" 
            encoded_Modules_name=$(echo "$Modules_name" | jq -sRr @uri)
            
            Surge_url="http://localhost:9100/file/_start_/${plugin_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=surge-module&category=${encoded_category}&nore=true&jqEnabled=true&keepHeader=true"
            Surge_Beta_url="http://localhost:9101/file/_start_/${plugin_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=surge-module&category=${encoded_category}&nore=true&jqEnabled=true&keepHeader=true&jqEnabled=true"
            Loon_url="http://localhost:9100/file/_start_/${plugin_url}/_end_/${encoded_Modules_name}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true&jqEnabled=true&keepHeader=true"
            Shadowrocket_url="http://localhost:9100/file/_start_/${plugin_url}/_end_/${encoded_Modules_name}.srmodule?type=loon-plugin&target=shadowrocket-module&category=${encoded_category}&nore=true&jqEnabled=true&keepHeader=true"

            echo "ğŸš€ Converting: ${Modules_name}"
            
            # ä½¿ç”¨æŒ‡å®š User-Agent æŠ“å–è½¬æ¢åçš„ç»“æœ
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/${Author}/${Modules_name}.sgmodule" "$Surge_url" || echo "âŒ Failed Surge"
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/${Author}/Beta/${Modules_name}.sgmodule" "$Surge_Beta_url" || echo "âŒ Failed Surge Beta"
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/${Author}/${Modules_name}.lpx" "$Loon_url" || echo "âŒ Failed Loon"
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/${Author}/${Modules_name}.srmodule" "$Shadowrocket_url" || echo "âŒ Failed Shadowrocket"

          done < plugin_urls.txt

      - name: Handle External JS Resources
        continue-on-error: true
        run: |
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"
          mkdir -p Modules/JS/${Author}

          # éå†ç”Ÿæˆçš„æ¨¡å—ï¼Œæå–é‡Œé¢çš„ JS é“¾æ¥å¹¶æœ¬åœ°åŒ–
          find Modules/Surge/${Author} -maxdepth 1 -type f -name "*.sgmodule" | while read -r surge_file; do
            module_folder=$(basename "$surge_file" .sgmodule)
            
            # æå– JS/JSON/JQ é“¾æ¥
            js_links=$(grep -v '#' "$surge_file" | grep -oP 'https?://[^ ]+\.(json|js|jq)' || true)

            if [ -n "$js_links" ]; then
              echo "ğŸ“¦ Localizing JS for $module_folder"
              for js_link in $js_links; do
                js_filename=$(basename "${js_link%%\?*}")
                local_js_path="Modules/JS/${Author}/$module_folder/$js_filename"
                github_js_url="$js_base_url/${Author}/$module_folder/$js_filename"
     
                mkdir -p "$(dirname "$local_js_path")"

                # æŠ“å–åŸå§‹è„šæœ¬ï¼ˆä¼ªè£…æˆ Surgeï¼‰
                if curl -sL -A "Surge Mac/2985" -o "$local_js_path" "$js_link"; then
                  escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
                  # æ›¿æ¢æ‰€æœ‰ç›¸å…³æ¨¡å—ä¸­çš„è¿œç¨‹é“¾æ¥ä¸ºè‡ªå·±çš„ GitHub é“¾æ¥
                  find Modules -name "${module_folder}.*" | xargs -I {} sed -i "s|$escaped_link|$github_js_url|g" "{}"
                fi
              done
            fi
          done

      - name: Commit and push changes
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          git add Modules
          if git diff --cached --quiet; then
            echo "âœ… No changes to commit."
          else
            git commit -m "Synched ddgksf2013 Modules at $DATE (UTC+8)"
            git pull --rebase --autostash || true
            git push
          fi
