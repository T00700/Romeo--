name: Mirror ddgksf2013 Modules

on:
  schedule:
    - cron: '15 */12 * * *'
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  Author: ddgksf2013

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    services:
      docker:
        image: xream/script-hub:latest
        ports: [9100:9100, 9101:9101]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      - name: Wait for Docker service
        run: |
          echo "Waiting for Docker..."
          timeout 60 bash -c 'until nc -z localhost 9100 && nc -z localhost 9101; do sleep 1; done'

      - name: Download Resources & Extract URLs
        run: |
          # 1. 提取 README 中的 URL
          curl -s https://raw.githubusercontent.com/ddgksf2013/ddgksf2013/main/README.md > README.md
          grep -oP '(?<=href=")[^"]+' README.md | \
          python3 -c "import sys, urllib.parse; [print(urllib.parse.unquote(l.strip())) for l in sys.stdin]" | \
          grep -oP 'https?://[^\s,"]+\.(sgmodule|snippet|conf|js)' > urls_temp.txt
          
          # 2. 从 data.json 提取所有 items 中的 url
          # 使用 jq 遍历 JSON 中所有 category 下的 items 数组，并输出 url 字段
          curl -s https://ddgksf2013.top/data.json | \
          jq -r '.[] | .items[] | .url' >> urls_temp.txt
          
          # 3. 合并、去重并过滤有效后缀
          # 增加对 .conf 和 .snippet 的兼容处理（脚本转换器通常支持这些）
          cat urls_temp.txt | sort -u | grep -E '\.(sgmodule|snippet|conf|js|lpx|srmodule)$' > plugin_urls.txt
          
          echo "Successfully extracted combined URLs:"
          cat plugin_urls.txt

      - name: Process files (Serialized for Stability)
        run: |
          category="Jacob"
          encoded_category=$(echo "$category" | jq -sRr @uri)
          
          mkdir -p Modules/{Surge,Loon,Shadowrocket}/${Author}/Beta

          while read -r plugin_url; do
            filename=$(basename "$plugin_url")
            Modules_name="${filename%.*}" 
            encoded_Modules_name=$(echo "$Modules_name" | jq -sRr @uri)

            # 保持原有的 Script-Hub 转换逻辑
            Surge_url="http://localhost:9100/file/_start_/${plugin_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=surge-module&category=${encoded_category}&del=true&nore=true&jqEnabled=truee"
            Surge_Beta_url="http://localhost:9101/file/_start_/${plugin_url}/_end_/${encoded_Modules_name}.sgmodule?type=loon-plugin&target=surge-module&category=${encoded_category}&del=true&nore=true&jqEnabled=true"
            Loon_url="http://localhost:9100/file/_start_/${plugin_url}/_end_/${encoded_Modules_name}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&del=true&nore=true&jqEnabled=true"
            Loon_Beta_url="http://localhost:9101/file/_start_/${plugin_url}/_end_/${encoded_Modules_name}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&del=true&nore=true&jqEnabled=true"
            Shadowrocket_url="http://localhost:9100/file/_start_/${plugin_url}/_end_/${encoded_Modules_name}.srmodule?type=loon-plugin&target=shadowrocket-module&category=${encoded_category}&del=true&nore=true&jqEnabled=true"
            Shadowrocket_Beta_url="http://localhost:9101/file/_start_/${plugin_url}/_end_/${encoded_Modules_name}.srmodule?type=loon-plugin&target=shadowrocket-module&category=${encoded_category}&del=true&nore=true&jqEnabled=true"

            echo "Processing ${Modules_name}..."
            
            # 使用 Surge User-Agent 获取转换后的内容
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/${Author}/${Modules_name}.sgmodule" "$Surge_url" || echo "Failed Surge"
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/${Author}/Beta/${Modules_name}.sgmodule" "$Surge_Beta_url" || echo "Failed Surge Beta"
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/${Author}/${Modules_name}.lpx" "$Loon_url" || echo "Failed Loon"
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/${Author}/Beta/${Modules_name}.lpx" "$Loon_Beta_url" || echo "Failed Loon Beta"
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/${Author}/${Modules_name}.srmodule" "$Shadowrocket_url" || echo "Failed Shadowrocket"
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/${Author}/Beta/${Modules_name}.srmodule" "$Shadowrocket_Beta_url" || echo "Failed Shadowrocket Beta"

          done < plugin_urls.txt

      - name: Handle External JS Resources
        continue-on-error: true
        run: |
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"
          mkdir -p Modules/JS/${Author}

          find Modules/Surge/${Author} -maxdepth 1 -type f -name "*.sgmodule" -print0 | while IFS= read -r -d '' surge_file; do
            module_folder=$(basename "$surge_file" .sgmodule)
            
            js_links=$(grep -v '#' "$surge_file" | grep -oP 'https?://[^\s]+\.(json|js|jq)' || true)

            if [ -z "$js_links" ]; then
              continue
            fi

            echo "Processing JS for $module_folder"

            for js_link in $js_links; do
              js_filename=$(basename "$js_link")
              local_js_path="Modules/JS/${Author}/$module_folder/$js_filename"
              github_js_url="$js_base_url/${Author}/$module_folder/$js_filename"
   
              mkdir -p "$(dirname "$local_js_path")"

              # 拉取 JS 时同样伪装 Surge
              if curl -sL -A "Surge Mac/2985" -o "$local_js_path" "$js_link"; then
                escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
                
                find Modules -name "${module_folder}.sgmodule" -o -name "${module_folder}.lpx" -o -name "${module_folder}.srmodule" | \
                xargs -I {} sed -i "s|$escaped_link|$github_js_url|g" "{}"
              fi
            done
          done

      - name: Commit and push changes
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          git add Modules

          if git diff --cached --quiet; then
            echo "✅ No changes to commit."
          else
            COMMIT_MESSAGE="Synched Modules at $DATE (UTC+8)"
            git commit -m "$COMMIT_MESSAGE"
            git pull --rebase --autostash || true
            git push || echo "Push failed."
          fi
