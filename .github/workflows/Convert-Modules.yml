name: Extract and Process Modules

on:
  schedule:
    - cron: '0,30 * * * *'
  workflow_dispatch:

jobs:
  Converting:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      - name: Wait for Docker services to be ready
        run: |
          echo "Waiting for Docker services to be ready..."
          timeout 60 bash -c 'until nc -z localhost 9100 && nc -z localhost 9101; do sleep 1; done'

      # === 1. ä¸‹è½½å¤‡ä»½ & ç”Ÿæˆå»é‡åçš„è½¬æ¢åˆ—è¡¨ ===
      - name: Download Backup & Deduplicate
        id: prepare
        run: |
          CONVERT_LIST="convert_tasks.txt"
          > "$CONVERT_LIST"
          
          # å…³è”æ•°ç»„ç”¨äºå»é‡ Key = Author/Filename
          declare -A seen_modules

          while read -r url; do
            # 1. åŸºç¡€è¿‡æ»¤
            if [[ "$url" =~ ^\s*#.* ]] || [[ -z "${url// }" ]]; then continue; fi
            
            # 2. è§£æä¿¡æ¯
            clean_url="${url%%\?*}" # å»æ‰URLå‚æ•°
            filename_full="${clean_url##*/}"
            filename_noext="${filename_full%.*}"
            extension="${filename_full##*.}"
            # è·å–ä½œè€… (å‡è®¾æ˜¯ç¬¬4æ®µ)
            author=$(echo "$clean_url" | cut -d'/' -f4)

            # 3. å¤‡ä»½é€»è¾‘ï¼šæ ¹æ®åç¼€å†³å®šå­˜æ”¾ä½ç½®
            save_dir=""
            case "$extension" in
              sgmodule)
                save_dir="Modules/Surge/$author/Official"
                ;;
              lpx|plugin)
                save_dir="Modules/Loon/$author/Official"
                ;;
              # å…¶ä»–æ ¼å¼ä¸å¤‡ä»½åˆ°Officialï¼Œä½†å¯èƒ½éœ€è¦è½¬æ¢
            esac

            if [[ -n "$save_dir" ]]; then
              mkdir -p "$save_dir"
              echo "ğŸ“¥ Backup: $filename_full -> $save_dir"
              # æ”¾å…¥åå°ä¸‹è½½ï¼Œä¸é˜»å¡
              curl -sL -A "Surge Mac/2985" -o "$save_dir/$filename_full" "$url" &
            fi

            # 4. å»é‡é€»è¾‘
            unique_key="${author}/${filename_noext}"
            
            if [[ -z "${seen_modules[$unique_key]}" ]]; then
              # å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡é‡åˆ°è¿™ä¸ªæ¨¡å— -> åŠ å…¥è½¬æ¢åˆ—è¡¨
              echo "$url" >> "$CONVERT_LIST"
              seen_modules["$unique_key"]=1
              echo "   âœ… Added to convert queue: $unique_key ($extension)"
            else
              # å¦‚æœå·²ç»é‡åˆ°è¿‡ -> è·³è¿‡è½¬æ¢ (ä½†ä¸Šé¢çš„å¤‡ä»½é€»è¾‘ä¾ç„¶ä¼šæ‰§è¡Œ)
              echo "   â© Duplicate detected, skipping conversion: $unique_key"
            fi

            # ç®€å•çš„å¹¶å‘æ§åˆ¶ï¼Œé˜²æ­¢å¤‡ä»½ä¸‹è½½ç§¯å‹å¤ªå¤š
            if [[ $(jobs -r -p | wc -l) -ge 20 ]]; then wait -n; fi

          done < Links/Modules-Links.txt
          
          wait # ç­‰å¾…æ‰€æœ‰å¤‡ä»½ä¸‹è½½å®Œæˆ
          echo "CONVERSION_LIST=$CONVERT_LIST" >> $GITHUB_ENV

      # === 2. æ‰§è¡Œè½¬æ¢ (ä½¿ç”¨å»é‡åçš„åˆ—è¡¨) ===
      - name: Convert Modules (Serialized)
        run: |
          category="Jacob"
          encoded_category=$(echo "$category" | jq -sRr @uri)
          
          if [ ! -f "$CONVERSION_LIST" ]; then
            echo "No tasks found."
            exit 0
          fi

          while read -r module_link; do
            [ -z "$module_link" ] && continue
            
            clean_url="${module_link%%\?*}"
            author=$(echo "$clean_url" | cut -d'/' -f4)
            filename_full="${clean_url##*/}"
            filename_noext="${filename_full%.*}"
            extension="${filename_full##*.}"
            
            encoded_module_link=$(echo "$module_link" | sed 's/ğŸ˜‚/%F0%9F%98%82/g')
            encoded_filename=$(echo "$filename_noext" | jq -sRr @uri)
            
            # ç¡®å®šæºç±»å‹
            case "$extension" in
              sgmodule) src_type="surge-module" ;;
              lpx|plugin) src_type="loon-plugin" ;;
              *) src_type="surge-module" ;;
            esac

            # æ„é€  URL (ä¿ç•™äº†ä½ æ·»åŠ çš„ jqEnabled å’Œ keepHeader)
            Surge_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.sgmodule?type=${src_type}&target=surge-module&category=${encoded_category}&nore=true&jqEnabled=true&keepHeader=true"
            Surge_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.sgmodule?type=${src_type}&target=surge-module&category=${encoded_category}&nore=true&jqEnabled=true&keepHeader=true"
            Loon_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.lpx?type=${src_type}&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true&jqEnabled=true&keepHeader=true"
            Loon_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.lpx?type=${src_type}&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true&jqEnabled=true&keepHeader=true"
            Shadowrocket_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.srmodule?type=${src_type}&target=shadowrocket-module&category=${encoded_category}&nore=true&jqEnabled=true&keepHeader=true"
            Shadowrocket_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.srmodule?type=${src_type}&target=shadowrocket-module&category=${encoded_category}&nore=true&jqEnabled=true&keepHeader=true"

            echo "ğŸ”„ Converting: $filename_noext ($author)"
            
            mkdir -p Modules/{Surge,Loon,Shadowrocket}/$author/Beta

            # ä¸²è¡Œä¸‹è½½ Beta
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/$author/Beta/$filename_noext.sgmodule" "$Surge_Beta_url"
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/$author/Beta/$filename_noext.lpx" "$Loon_Beta_url"
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/$author/Beta/$filename_noext.srmodule" "$Shadowrocket_Beta_url"

            # ç”Ÿæˆé Beta ç‰ˆ (å¦‚æœåŸæ–‡ä»¶ä¸æ˜¯è¯¥æ ¼å¼ï¼Œåˆ™ç”Ÿæˆ)
            # è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šä¸ç®¡åŸæ–‡ä»¶æœ‰æ²¡æœ‰ï¼Œéƒ½ç”Ÿæˆä¸€éæ”¾åœ¨æ ¹ç›®å½•(Modules/Surge/$author/)ï¼Œ
            # å¦‚æœåŸæ–‡ä»¶åœ¨ Officialï¼Œé‚£è¿™é‡Œç”Ÿæˆçš„å…¶å®æ˜¯ä¸€ä¸ªâ€œè½¬æ¢ç‰ˆâ€æˆ–è€…â€œå‰¯æœ¬â€ã€‚
            # æ ¹æ®ä½ ä¹‹å‰çš„é€»è¾‘ï¼Œè¿™é‡Œæ˜¯éœ€è¦çš„ï¼š
            if [[ "$extension" != "sgmodule" ]]; then
               mkdir -p "Modules/Surge/$author"
               curl -sL -A "Surge Mac/2985" -o "Modules/Surge/$author/$filename_noext.sgmodule" "$Surge_url"
            fi
            if [[ "$extension" != "lpx" && "$extension" != "plugin" ]]; then
               mkdir -p "Modules/Loon/$author"
               curl -sL -A "Surge Mac/2985" -o "Modules/Loon/$author/$filename_noext.lpx" "$Loon_url"
            fi
            # Shadowrocket æ²¡æœ‰ Official æ¦‚å¿µï¼Œæ€»æ˜¯ç”Ÿæˆ
            mkdir -p "Modules/Shadowrocket/$author"
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/$author/$filename_noext.srmodule" "$Shadowrocket_url"

          done < "$CONVERSION_LIST"

      - name: Collect authors
        run: |
          authors=$(grep -E '^https?://' Links/Modules-Links.txt | cut -d'/' -f4 | sort -u | tr '\n' ' ')
          echo "AUTHORS=$authors" >> $GITHUB_ENV

      # === 3. JS æ›¿æ¢ ===
      - name: Find and replace external JS resources
        continue-on-error: true
        run: |
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"
          mkdir -p Modules/JS

          # éå†ä½œè€…
          for author in $AUTHORS; do
            # æ‰«æè¯¥ä½œè€… Surge Official ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œä»¥åŠæ ¹ç›®å½•ä¸‹çš„è½¬æ¢æ–‡ä»¶ (æ’é™¤ Beta)
            # ä½¿ç”¨ -maxdepth 2 å¯èƒ½ä¼šæ‰«åˆ° Official å’Œ æ ¹ç›®å½•ï¼Œæˆ‘ä»¬åˆ†å¼€å†™æ›´ç²¾ç¡®
            
            # 1. æŸ¥æ‰¾ Official ç›®å½•
            find "Modules/Surge/$author/Official" -type f -name "*.sgmodule" 2>/dev/null > files_to_scan.txt
            # 2. æŸ¥æ‰¾è½¬æ¢ç”Ÿæˆçš„æ ¹ç›®å½•æ–‡ä»¶ (é Official, é Beta)
            find "Modules/Surge/$author" -maxdepth 1 -type f -name "*.sgmodule" 2>/dev/null >> files_to_scan.txt

            while read sgmodule_file; do
              [ -f "$sgmodule_file" ] || continue
              
              module_folder=$(basename "$sgmodule_file" .sgmodule)
              
              js_links=$(grep -v '#' "$sgmodule_file" | grep -oP 'https?://[^ \"\)]+\.(json|js|jq)' || echo "")
              
              if [ -z "$js_links" ]; then continue; fi

              echo "Processing JS links for $module_folder ($author)..."

              for js_link in $js_links; do
                js_filename=$(basename "$js_link")
                local_js_dir="Modules/JS/$author/$module_folder"
                local_js_path="$local_js_dir/$js_filename"
                github_js_url="$js_base_url/$author/$module_folder/$js_filename"
   
                if [ ! -f "$local_js_path" ]; then
                   mkdir -p "$local_js_dir"
                   if ! curl -sL -A "Surge Mac/2985" -o "$local_js_path" "$js_link"; then
                      echo "  âŒ Failed download: $js_link"
                      continue
                   fi
                fi

                escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
                
                # æ‰¹é‡æ›¿æ¢ï¼šé™åˆ¶åœ¨å½“å‰ä½œè€…ç›®å½•ä¸‹æŸ¥æ‰¾æ‰€æœ‰ç›¸å…³æ–‡ä»¶ (åŒ…æ‹¬ Beta)
                find "Modules" -path "*/$author/*" \( -name "${module_folder}.sgmodule" -o -name "${module_folder}.lpx" -o -name "${module_folder}.srmodule" -o -name "${module_folder}.plugin" \) -print0 | \
                xargs -0 sed -i "s|$escaped_link|$github_js_url|g"
              done
            done < files_to_scan.txt
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          git add Modules/*
          rm -f "$CONVERSION_LIST" files_to_scan.txt
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MESSAGE="Converted modules at $DATE (UTC+8)"
            git stash
            git pull --rebase --autostash || true
            git stash pop || true
            git add Modules/*
            git commit -m "$COMMIT_MESSAGE"
            git push
          fi
