name: Extract and Process Modules

on:
  schedule:
    - cron: '0,30 * * * *'
  workflow_dispatch:

jobs:
  Converting:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      - name: Wait for Docker services to be ready
        run: |
          echo "Waiting for Docker services to be ready..."
          timeout 60 bash -c 'until nc -z localhost 9100 && nc -z localhost 9101; do sleep 1; done'

      ---

      ## ğŸ’¾ 1. ä¸‹è½½åŸå§‹æ–‡ä»¶å¹¶åˆ†ç±»ä¿å­˜ (æ ¹æ®åç¼€)
      - name: Download and Categorize Raw Files
        id: download_files
        run: |
          # ç”¨äºå­˜å‚¨éœ€è¦è½¬æ¢çš„å”¯ä¸€é“¾æ¥ (é¿å…é‡å¤è½¬æ¢åŒåæ¨¡å—)
          conversion_links_file="conversion_links.txt"
          > "$conversion_links_file"
          
          echo "Starting download and categorization..."
          
          while read -r module_link; do
            # å¿½ç•¥æ³¨é‡Šæˆ–ç©ºè¡Œ
            if [[ "$module_link" =~ ^\s*#.* ]] || [[ -z "${module_link// }" ]]; then
              continue
            fi
            
            author=$(echo "$module_link" | cut -d'/' -f4)
            filename_full=$(basename "$module_link")
            filename_noext=$(basename "$module_link" | sed 's/\(.*\)\..*/\1/')
            extension="${filename_full##*.}"
            
            # ç¡®å®šä¿å­˜çš„é¡¶å±‚ç›®å½•
            case "$extension" in
              sgmodule)
                TARGET_TYPE="Surge"
                TARGET_DIR="Modules/Surge/$author/Official"
                ;;
              lpx|plugin)
                TARGET_TYPE="Loon"
                TARGET_DIR="Modules/Loon/$author/Official"
                ;;
              *)
                echo "âš ï¸ Skipping unsupported file type: $filename_full"
                continue
                ;;
            esac
            
            # æ„é€ æœ¬åœ°ä¿å­˜è·¯å¾„
            FINAL_FILENAME="${filename_noext}.${extension}"
            LOCAL_PATH="$TARGET_DIR/$FINAL_FILENAME"

            # åˆ›å»ºç›®å½•
            mkdir -p "$TARGET_DIR"
            mkdir -p Modules/{Surge,Loon,Shadowrocket}/$author/Beta
            mkdir -p Modules/JS/$author/Beta

            echo "ğŸ“¥ Downloading $FINAL_FILENAME to $TARGET_DIR..."

            # ä¸‹è½½åŸå§‹æ–‡ä»¶
            if curl -sL -A "Surge Mac/2985" -o "$LOCAL_PATH" "$module_link"; then
              # å¦‚æœä¸‹è½½æˆåŠŸï¼Œå°†åŸå§‹é“¾æ¥æ·»åŠ åˆ°è½¬æ¢åˆ—è¡¨ä¸­
              # æ ¼å¼: $author/$filename_noext/$module_link
              # ä½¿ç”¨ module_link ä½œä¸º key ç¡®ä¿å”¯ä¸€æ€§
              if ! grep -q "^$author/$filename_noext/" "$conversion_links_file"; then
                echo "$author/$filename_noext/$module_link" >> "$conversion_links_file"
                echo "  âœ… Saved to conversion list."
              else
                echo "  â¡ï¸ File already in conversion list for $author/$filename_noext. Skipping duplicate conversion request."
              fi
            else
              echo "  âŒ Failed to download raw file: $module_link"
            fi
            
          done < Links/Modules-Links.txt
          
          # å°† conversion_links_file ä¿å­˜åˆ°ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "CONVERSION_LINKS_FILE=$conversion_links_file" >> $GITHUB_ENV

      ---

      ## âš™ï¸ 2. æ‰§è¡Œæ¨¡å—æ ¼å¼è½¬æ¢ (åŸºäºæ”¶é›†çš„é“¾æ¥)
      - name: Convert Modules
        run: |
          category="Jacob"
          encoded_category=$(echo "$category" | jq -sRr @uri)
          
          # è¯»å–ä¸Šä¸€æ­¥ä¿å­˜çš„å”¯ä¸€è½¬æ¢åˆ—è¡¨
          while IFS="/" read -r author filename_noext module_link; do
            
            if [[ -z "$module_link" ]]; then continue; fi
            
            encoded_module_link=$(echo "$module_link" | sed 's/ğŸ˜‚/%F0%9F%98%82/g')
            encoded_filename=$(echo "$filename_noext" | jq -sRr @uri)
            
            # ç¡®å®šåŸå§‹æ–‡ä»¶çš„ç±»å‹ï¼Œç”¨äºæ„é€ è½¬æ¢ URL çš„ type å‚æ•°
            extension="${module_link##*.}"
            case "$extension" in
              sgmodule)
                ORIGINAL_TYPE="surge-module"
                ;;
              lpx|plugin)
                ORIGINAL_TYPE="loon-plugin"
                ;;
              *)
                echo "Skipping conversion for unsupported type: $extension"
                continue
                ;;
            esac
            
            echo "ğŸ”„ Converting $filename_noext by $author using source: $extension"

            # --- æ„é€ ç›®æ ‡è½¬æ¢ URL ---
            
            # åŸºç¡€ URL ç»“æ„: http://localhost:[port]/file/_start_/[åŸå§‹é“¾æ¥]/_end_/[ç›®æ ‡æ–‡ä»¶å]...
            
            Surge_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.sgmodule?type=${ORIGINAL_TYPE}&target=surge-module&category=${encoded_category}&nore=true"
            Surge_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.sgmodule?type=${ORIGINAL_TYPE}&target=surge-module&category=${encoded_category}&nore=true&jqEnabled=true"
            
            Loon_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.lpx?type=${ORIGINAL_TYPE}&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true"
            Loon_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.lpx?type=${ORIGINAL_TYPE}&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true&jqEnabled=true"
            
            Shadowrocket_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.srmodule?type=${ORIGINAL_TYPE}&target=shadowrocket-module&category=${encoded_category}&nore=true"
            Shadowrocket_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.srmodule?type=${ORIGINAL_TYPE}&target=shadowrocket-module&category=${encoded_category}&nore=true&jqEnabled=true"

            # --- ä¸²è¡Œä¸‹è½½è½¬æ¢æ–‡ä»¶ ---
            
            curl -A "Surge Mac/2985" -L -o "Modules/Surge/$author/$filename_noext.sgmodule" "$Surge_url" || echo "Failed Surge Official"
            curl -A "Surge Mac/2985" -L -o "Modules/Surge/$author/Beta/$filename_noext.sgmodule" "$Surge_Beta_url" || echo "Failed Surge Beta"
            
            curl -A "Surge Mac/2985" -L -o "Modules/Loon/$author/$filename_noext.lpx" "$Loon_url" || echo "Failed Loon Official"
            curl -A "Surge Mac/2985" -L -o "Modules/Loon/$author/Beta/$filename_noext.lpx" "$Loon_Beta_url" || echo "Failed Loon Beta"
            
            curl -A "Surge Mac/2985" -L -o "Modules/Shadowrocket/$author/$filename_noext.srmodule" "$Shadowrocket_url" || echo "Failed Shadowrocket Official"
            curl -A "Surge Mac/2985" -L -o "Modules/Shadowrocket/$author/Beta/$filename_noext.srmodule" "$Shadowrocket_Beta_url" || echo "Failed Shadowrocket Beta"
            
          done < "$CONVERSION_LINKS_FILE"

      ---
      
      # æ¢å¤ï¼šæ”¶é›†ä½œè€…åˆ—è¡¨ (ç»§ç»­ä½¿ç”¨ Modules-Links.txt ä½œä¸ºæºï¼Œä¿æŒä¸€è‡´æ€§)
      - name: Collect authors
        run: |
          authors=$(grep -E '^https?://' Links/Modules-Links.txt | cut -d'/' -f4 | sort -u | tr '\n' ' ')
          echo "AUTHORS=$authors" >> $GITHUB_ENV

      - name: Find and replace external JS resources
        continue-on-error: true
        run: |
          # ... (æ­¤æ­¥éª¤ä»£ç ä¿æŒä¸å˜ï¼Œå› ä¸ºå®ƒä¾èµ–äº $AUTHORS å˜é‡ï¼Œä¼šæ‰«æ Modules/Surge/$author ç›®å½•ä¸‹çš„æ–‡ä»¶) ...
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"

          # éå†æ¯ä¸ªä½œè€…
          for author in $AUTHORS; do
            echo "Scanning modules for author: $author"
            
            # æ ¸å¿ƒé€»è¾‘ï¼šæ‰«æ Modules/Surge/$author/Official ç›®å½•ä¸‹çš„åŸå§‹æ–‡ä»¶
            # ä»¥åŠ Modules/Surge/$author æ ¹ç›®å½•ä¸‹çš„è½¬æ¢æ–‡ä»¶ (ç¡®ä¿æ‰«æåˆ°æ‰€æœ‰æ–‡ä»¶)
            find "Modules/Surge/$author" -type f -name "*.sgmodule" | while read sgmodule_file; do
              
              # ç¡®ä¿åªå¤„ç† Surge æ¨¡å—ï¼Œé¿å…é‡å¤å¤„ç† Loon æ’ä»¶
              if [[ "$sgmodule_file" == *"Loon"* ]]; then continue; fi

              module_folder=$(basename "$sgmodule_file" .sgmodule)
              
              # æå– JS é“¾æ¥ (ä¸é™å…³é”®è¯ï¼ŒåŒ¹é…æ‰€æœ‰ http js)
              js_links=$(grep -v '#' "$sgmodule_file" | grep -oP 'https?://[^ \"\)]+\.(json|js|jq)' || echo "")
              
              if [ -z "$js_links" ]; then continue; fi

              echo "Processing JS links for $module_folder..."

              for js_link in $js_links; do
                js_filename=$(basename "$js_link")
                local_js_path="Modules/JS/$author/$module_folder/$js_filename"
                github_js_url="$js_base_url/$author/$module_folder/$js_filename"
   
                mkdir -p "$(dirname "$local_js_path")"

                if curl -sL -A "Surge Mac/2985" -o "$local_js_path" "$js_link"; then
                  
                  escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
                  
                  # æ‰¹é‡æ›¿æ¢ï¼šæŸ¥æ‰¾å½“å‰ä½œè€…ç›®å½•ä¸‹æ‰€æœ‰ç›¸å…³æ–‡ä»¶ (.sgmodule, .lpx, .srmodule)
                  # æ›¿æ¢èŒƒå›´åŒ…æ‹¬ Official ç›®å½•å’Œ Beta ç›®å½•
                  find "Modules" -path "*/$author/*" \( -name "${module_folder}.sgmodule" -o -name "${module_folder}.lpx" -o -name "${module_folder}.srmodule" -o -name "${module_folder}.plugin" \) | \
                  xargs -I {} sed -i "s|$escaped_link|$github_js_url|g" "{}"
                  
                fi
              done
            done
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          git add Modules/*
          # Clean up temporary file
          rm -f "$CONVERSION_LINKS_FILE"
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            # ... (Commit logic remains the same)
            COMMIT_MESSAGE="Converted modules at $DATE (UTC+8)"
            git stash
            git pull --rebase --autostash || true
            git stash pop || true
            git add Modules/*
            git commit -m "$COMMIT_MESSAGE"
            git push
          fi
