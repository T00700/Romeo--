name: Extract and Process Modules

on:
  schedule:
    - cron: '0,30 * * * *'
  workflow_dispatch:

jobs:
  Converting:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      - name: Wait for Docker services to be ready
        run: |
          echo "Waiting for Docker services..."
          timeout 60 bash -c 'until nc -z localhost 9100 && nc -z localhost 9101; do sleep 1; done'

      # === æ ¸å¿ƒæ­¥éª¤ï¼šä¸‹è½½å¤‡ä»½ + æ™ºèƒ½åŽ»é‡ç”Ÿæˆè½¬æ¢åˆ—è¡¨ ===
      - name: Analyze, Download and Deduplicate
        id: prepare_list
        run: |
          # 1. åˆå§‹åŒ–
          CONVERT_LIST="convert_tasks.txt"
          touch "$CONVERT_LIST"
          declare -A seen_modules # ç”¨äºŽåŽ»é‡çš„å…³è”æ•°ç»„

          echo "ðŸš€ Starting processing..."

          while read -r url; do
            # è·³è¿‡æ— æ•ˆè¡Œ
            if [[ "$url" =~ ^\s*#.* ]] || [[ -z "${url// }" ]]; then continue; fi

            # 2. è§£æžå…ƒæ•°æ®
            author=$(echo "$url" | cut -d'/' -f4)
            filename_full=$(basename "$url")
            filename_noext="${filename_full%.*}"
            extension="${filename_full##*.}"

            # 3. é€»è¾‘åˆ†æ”¯ A: ä¸‹è½½å¤‡ä»½ (æ— è®ºæ˜¯å¦åŽ»é‡ï¼Œç¬¦åˆæ ¼å¼éƒ½è¦ä¸‹è½½)
            save_dir=""
            case "$extension" in
              sgmodule)
                save_dir="Modules/Surge/$author/Official"
                ;;
              lpx|plugin)
                save_dir="Modules/Loon/$author/Official"
                ;;
            esac

            if [[ -n "$save_dir" ]]; then
              echo "ðŸ“‚ Creating dir: $save_dir"
              mkdir -p "$save_dir" # ç¡®ä¿æ–‡ä»¶å¤¹å­˜åœ¨
              
              echo "â¬‡ï¸  Downloading backup: $filename_full"
              if curl -sL -A "Surge Mac/2985" -o "$save_dir/$filename_full" "$url"; then
                 echo "   âœ… Saved to $save_dir"
              else
                 echo "   âŒ Download failed"
              fi
            fi

            # 4. é€»è¾‘åˆ†æ”¯ B: æ™ºèƒ½åŽ»é‡å¹¶æ·»åŠ åˆ°è½¬æ¢åˆ—è¡¨
            # å”¯ä¸€æ ‡è¯†: ä½œè€… + æ–‡ä»¶å (ä¸å«åŽç¼€)
            unique_key="${author}/${filename_noext}"

            if [[ -z "${seen_modules[$unique_key]}" ]]; then
              # å¦‚æžœæ˜¯ç¬¬ä¸€æ¬¡é‡åˆ°è¿™ä¸ªæ¨¡å— -> æ·»åŠ åˆ°è½¬æ¢åˆ—è¡¨
              echo "$url" >> "$CONVERT_LIST"
              seen_modules["$unique_key"]=1
              echo "   First time seeing $unique_key -> Added to conversion queue."
            else
              # å¦‚æžœå·²ç»é‡åˆ°è¿‡ -> è·³è¿‡è½¬æ¢ (ä½†ä¸Šé¢å·²ç»ä¸‹è½½å¤‡ä»½äº†)
              echo "   Duplicate module $unique_key -> Skipping conversion."
            fi

          done < Links/Modules-Links.txt

      # === ä¸²è¡Œè½¬æ¢ (åªå¤„ç† convert_tasks.txt ä¸­çš„é“¾æŽ¥) ===
      - name: Convert Modules (Serialized)
        run: |
          category="Jacob"
          encoded_category=$(echo "$category" | jq -sRr @uri)
          
          if [ ! -f convert_tasks.txt ]; then
            echo "No tasks found."
            exit 0
          fi

          while read -r module_link; do
            [ -z "$module_link" ] && continue

            # è§£æžä¿¡æ¯
            encoded_module_link=$(echo "$module_link" | sed 's/ðŸ˜‚/%F0%9F%98%82/g')
            author=$(echo "$module_link" | cut -d'/' -f4)
            filename_full=$(basename "$module_link")
            filename_noext="${filename_full%.*}"
            encoded_filename=$(echo "$filename_noext" | jq -sRr @uri)
            
            # åˆ¤æ–­åŽŸå§‹ç±»åž‹
            extension="${filename_full##*.}"
            case "$extension" in
              sgmodule) TYPE_PARAM="surge-module" ;;
              lpx|plugin) TYPE_PARAM="loon-plugin" ;;
              *) TYPE_PARAM="surge-module" ;; # é»˜è®¤å›žé€€
            esac

            # åˆ›å»º Beta ç›®å½• (Official ç›®å½•åœ¨ä¸Šä¸€æ­¥å·²ç»æŒ‰éœ€åˆ›å»ºäº†)
            mkdir -p Modules/{Surge,Loon,Shadowrocket}/$author/Beta

            # æž„é€  URL
            Surge_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.sgmodule?type=${TYPE_PARAM}&target=surge-module&category=${encoded_category}&nore=true"
            Surge_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.sgmodule?type=${TYPE_PARAM}&target=surge-module&category=${encoded_category}&nore=true&jqEnabled=true"
            Loon_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.lpx?type=${TYPE_PARAM}&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true"
            Loon_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.lpx?type=${TYPE_PARAM}&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true&jqEnabled=true"
            Shadowrocket_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.srmodule?type=${TYPE_PARAM}&target=shadowrocket-module&category=${encoded_category}&nore=true"
            Shadowrocket_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.srmodule?type=${TYPE_PARAM}&target=shadowrocket-module&category=${encoded_category}&nore=true&jqEnabled=true"

            echo "ðŸ”„ Converting: $filename_noext ($author)"

            # ç”Ÿæˆ Beta ç‰ˆ (å¿…é¡»)
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/$author/Beta/$filename_noext.sgmodule" "$Surge_Beta_url"
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/$author/Beta/$filename_noext.lpx" "$Loon_Beta_url"
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/$author/Beta/$filename_noext.srmodule" "$Shadowrocket_Beta_url"
            
            # ç”Ÿæˆè½¬æ¢åŽçš„æ­£å¼ç‰ˆ (å­˜æ”¾åˆ°æ ¹ç›®å½•ï¼Œä¸ºäº†è·¨å¹³å°)
            # ä¾‹å¦‚ï¼šè™½ç„¶æœ‰äº† Official/xxx.sgmoduleï¼Œä½†æˆ‘ä»¬éœ€è¦è½¬æ¢å‡º Loon å’Œ Shadowrocket æ ¼å¼ç»™ç”¨æˆ·ç”¨
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/$author/$filename_noext.sgmodule" "$Surge_url"
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/$author/$filename_noext.lpx" "$Loon_url"
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/$author/$filename_noext.srmodule" "$Shadowrocket_url"

          done < convert_tasks.txt

      # === JS æ›¿æ¢ ===
      - name: Find and replace external JS resources
        continue-on-error: true
        run: |
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"
          mkdir -p Modules/JS

          # æŸ¥æ‰¾ Modules ç›®å½•ä¸‹æ‰€æœ‰ç›¸å…³æ–‡ä»¶ (åŒ…æ‹¬ Official å’Œ Beta)
          find Modules -type f \( -name "*.sgmodule" -o -name "*.lpx" -o -name "*.srmodule" \) | while read file; do
            
            # æå–ä¿¡æ¯
            # è·¯å¾„ç¤ºä¾‹: Modules/Surge/kokoryh/Official/bilibili.sgmodule
            # æˆ–è€…: Modules/Surge/kokoryh/bilibili.sgmodule
            # æˆ‘ä»¬éœ€è¦æå–ä½œè€…åï¼Œé€šå¸¸æ˜¯ç¬¬3éƒ¨åˆ†
            author=$(echo "$file" | cut -d'/' -f3)
            module_name=$(basename "$file")
            
            # æå– JS é“¾æŽ¥
            js_links=$(grep -v '#' "$file" | grep -oP 'https?://[^ \"\)]+\.(json|js|jq)' || echo "")
            
            if [ -z "$js_links" ]; then continue; fi
            
            for js_link in $js_links; do
              js_filename=$(basename "$js_link")
              # JS ä¿å­˜è·¯å¾„: Modules/JS/ä½œè€…/æ¨¡å—å(æ— åŽç¼€)/æ–‡ä»¶å
              local_js_path="Modules/JS/$author/${module_name%.*}/$js_filename"
              github_js_url="$js_base_url/$author/${module_name%.*}/$js_filename"
              
              # ä¸‹è½½ JS (å¦‚æžœæœ¬åœ°ä¸å­˜åœ¨åˆ™ä¸‹è½½)
              if [ ! -f "$local_js_path" ]; then
                 mkdir -p "$(dirname "$local_js_path")"
                 if curl -sL -A "Surge Mac/2985" -o "$local_js_path" "$js_link"; then
                    : # Downloaded
                 else
                    echo "  âŒ Failed download JS: $js_link"
                    continue
                 fi
              fi
              
              # æ›¿æ¢å½“å‰æ–‡ä»¶ä¸­çš„é“¾æŽ¥
              escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
              sed -i "s|$escaped_link|$github_js_url|g" "$file"
            done
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          git add Modules/*
          rm -f convert_tasks.txt
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MESSAGE="Converted modules at $DATE (UTC+8)"
            git stash
            git pull --rebase --autostash || true
            git stash pop || true
            git add Modules/*
            git commit -m "$COMMIT_MESSAGE"
            git push
          fi
