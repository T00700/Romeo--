name: Extract and Process Modules

on:
  schedule:
    - cron: '0,30 * * * *'
  workflow_dispatch:

jobs:
  Converting:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      - name: Wait for Docker services to be ready
        run: |
          echo "Waiting for Docker services..."
          timeout 60 bash -c 'until nc -z localhost 9100 && nc -z localhost 9101; do sleep 1; done'

      - name: Download Official Files & Prepare Conversion
        id: prepare
        run: |
          # è½¬æ¢ä»»åŠ¡åˆ—è¡¨
          CONVERT_LIST="convert_tasks.txt"
          > "$CONVERT_LIST"
          
          # å»é‡è®°å½•è¡¨ (Key: Author_Filename)
          declare -A seen_keys
          # è¯»å–é“¾æ¥æ–‡ä»¶
          while read -r raw_url; do
            # 1. è¿‡æ»¤æ— æ•ˆè¡Œ
            if [[ "$raw_url" =~ ^\s*#.* ]] || [[ -z "${raw_url// }" ]]; then continue; fi
            # 2. URL æ¸…æ´— (å»æ‰ ? åé¢çš„å‚æ•°ï¼Œå¦åˆ™æ— æ³•è¯†åˆ«åç¼€)
            clean_url="${raw_url%%\?*}"
            
            # 3. è§£æä¿¡æ¯
            # å‡è®¾é“¾æ¥æ ¼å¼ github.com/Author/... æˆ– raw/Author/...
            # è¿™é‡Œçš„ cut -f4 å–å†³äºä½ çš„é“¾æ¥æ ¼å¼ï¼Œå¦‚æœæ˜¯ raw.githubusercontent.com/Author/Repo... åˆ™æ˜¯ f4
            # å»ºè®®ç”¨æ›´é€šç”¨çš„æ–¹å¼æå–ä½œè€…ï¼ˆå‡è®¾æ˜¯è·¯å¾„ä¸­çš„æŸä¸€éƒ¨åˆ†ï¼Œæˆ–è€…ä¿æŒåŸæ ·ï¼‰
            # è¿™é‡Œæ²¿ç”¨ä½ ä¹‹å‰çš„é€»è¾‘ï¼šcut -d'/' -f4
            author=$(echo "$clean_url" | cut -d'/' -f4)
            
            filename_full=$(basename "$clean_url")
            extension="${filename_full##*.}"
            filename_noext="${filename_full%.*}"
            
            # 4. ç¡®å®šä¸‹è½½ç›®æ ‡ (Official å¤‡ä»½)
            should_download=false
            target_dir=""
            
            case "$extension" in
              sgmodule)
                target_dir="Modules/Surge/$author/Official"
                should_download=true
                ;;
              lpx|plugin)
                target_dir="Modules/Loon/$author/Official"
                should_download=true
                ;;
              *)
                # å…¶ä»–æ ¼å¼ä¸å­˜ Officialï¼Œä½†è¦è½¬æ¢
                should_download=false
                ;;
            esac
            # 5. æ‰§è¡Œä¸‹è½½ (å¤‡ä»½åŸæ–‡ä»¶)
            if [ "$should_download" = true ]; then
              mkdir -p "$target_dir"
              echo "ğŸ“¥ Downloading Backup: $filename_full -> $target_dir"
              curl -sL -A "Surge Mac/2985" -o "$target_dir/$filename_full" "$raw_url"
            fi
            # 6. ç”Ÿæˆè½¬æ¢ä»»åŠ¡ (æ™ºèƒ½å»é‡)
            # å”¯ä¸€Key: ä½œè€…/æ–‡ä»¶å (ä¸å«åç¼€)
            unique_key="${author}/${filename_noext}"
            if [[ -z "${seen_keys[$unique_key]}" ]]; then
              # è®°å½•ä»»åŠ¡: åŸå§‹é“¾æ¥ (å¸¦å‚æ•°çš„)
              echo "$raw_url" >> "$CONVERT_LIST"
              seen_keys["$unique_key"]=1
              echo "   âœ… Added to convert queue: $unique_key"
            else
              echo "   â© Duplicate detected, skipping conversion: $unique_key"
            fi
          done < Links/Modules-Links.txt
          
          echo "CONVERSION_LIST=$CONVERT_LIST" >> $GITHUB_ENV

      - name: Debug - List Files
        run: |
          echo "=== Checking Modules Directory Structure ==="
          if [ -d "Modules" ]; then
            find Modules -maxdepth 4 -not -path '*/.*'
          else
            echo "âŒ Modules directory was not created!"
          fi
          echo "=========================================="

      - name: Convert Modules
        run: |
          category="Jacob"
          encoded_category=$(echo "$category" | jq -sRr @uri)
          
          if [ ! -f "$CONVERSION_LIST" ]; then
            echo "No conversion tasks."
            exit 0
          fi
          while read -r module_link; do
            [ -z "$module_link" ] && continue
            # æ¸…æ´— & è§£æ
            clean_url="${module_link%%\?*}"
            author=$(echo "$clean_url" | cut -d'/' -f4)
            filename_full=$(basename "$clean_url")
            filename_noext="${filename_full%.*}"
            extension="${filename_full##*.}"
            
            # URL ç¼–ç 
            encoded_module_link=$(echo "$module_link" | sed 's/ğŸ˜‚/%F0%9F%98%82/g')
            encoded_filename=$(echo "$filename_noext" | jq -sRr @uri)
            # æ ¹æ®åŸå§‹æ–‡ä»¶ç±»å‹è®¾ç½® type å‚æ•°
            # å¦‚æœä¸æŒ‡å®šï¼Œscript-hub ä¼šå°è¯•è‡ªåŠ¨æ¢æµ‹ï¼Œä½†æŒ‡å®šæ›´ç¨³
            case "$extension" in
              sgmodule) src_type="surge-module" ;;
              lpx|plugin) src_type="loon-plugin" ;;
              *) src_type="surge-module" ;; # é»˜è®¤å›é€€
            esac
            # æ„é€  Script-Hub URL
            Surge_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.sgmodule?type=${src_type}&target=surge-module&category=${encoded_category}&nore=true"
            Surge_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.sgmodule?type=${src_type}&target=surge-module&category=${encoded_category}&nore=true&jqEnabled=true"
            
            Loon_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.lpx?type=${src_type}&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true"
            Loon_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.lpx?type=${src_type}&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true&jqEnabled=true"
            
            Shadowrocket_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.srmodule?type=${src_type}&target=shadowrocket-module&category=${encoded_category}&nore=true"
            Shadowrocket_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.srmodule?type=${src_type}&target=shadowrocket-module&category=${encoded_category}&nore=true&jqEnabled=true"
            echo "ğŸ”„ Converting: $filename_noext ($author)"
            
            # åˆ›å»º Beta ç›®å½• (Betaæ–‡ä»¶æ€»æ˜¯è¦ç”Ÿæˆçš„)
            mkdir -p Modules/{Surge,Loon,Shadowrocket}/$author/Beta
            # ä¸‹è½½è½¬æ¢åçš„æ–‡ä»¶
            # 1. ç”Ÿæˆ Beta ç‰ˆ (å¿…é¡»)
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/$author/Beta/$filename_noext.sgmodule" "$Surge_Beta_url"
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/$author/Beta/$filename_noext.lpx" "$Loon_Beta_url"
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/$author/Beta/$filename_noext.srmodule" "$Shadowrocket_Beta_url"
            # 2. ç”Ÿæˆ/è¡¥å…… Official ç‰ˆ (éBeta)
            # å¦‚æœè¯¥æ ¼å¼çš„ Official ç›®å½•é‡Œæ²¡æœ‰åŸæ–‡ä»¶ï¼ˆæ¯”å¦‚åŸæ–‡ä»¶æ˜¯sgmoduleï¼Œç°åœ¨è¦ç”Ÿæˆsrmoduleï¼‰ï¼Œåˆ™ä¸‹è½½
            # ä¸ºäº†ç®€å•é€»è¾‘ï¼šæˆ‘ä»¬æ€»æ˜¯å°è¯•ç”Ÿæˆå¯¹åº”çš„â€œè½¬æ¢ç‰ˆâ€åˆ°æ ¹ç›®å½• (Modules/Surge/$author/$file)ï¼Œé™¤éé‚£æ˜¯åŸæ–‡ä»¶å­˜æ”¾çš„ Official ç›®å½•
            
            # Surge
            if [[ "$extension" != "sgmodule" ]]; then
               mkdir -p "Modules/Surge/$author"
               curl -sL -A "Surge Mac/2985" -o "Modules/Surge/$author/$filename_noext.sgmodule" "$Surge_url"
            fi
            
            # Loon
            if [[ "$extension" != "lpx" && "$extension" != "plugin" ]]; then
               mkdir -p "Modules/Loon/$author"
               curl -sL -A "Surge Mac/2985" -o "Modules/Loon/$author/$filename_noext.lpx" "$Loon_url"
            fi
            
            # Shadowrocket (æ€»æ˜¯ç”Ÿæˆï¼Œå› ä¸ºæ²¡æœ‰ Shadowrocket çš„ Official åŸæ–‡ä»¶æ¥æº)
            mkdir -p "Modules/Shadowrocket/$author"
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/$author/$filename_noext.srmodule" "$Shadowrocket_url"
          done < "$CONVERSION_LIST"

      - name: Collect authors
        run: |
          authors=$(grep -E '^https?://' Links/Modules-Links.txt | cut -d'/' -f4 | sort -u | tr '\n' ' ')
          echo "AUTHORS=$authors" >> $GITHUB_ENV
          
      - name: Find and replace external JS resources
        continue-on-error: true
        run: |
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"

          # éå†æ¯ä¸ªä½œè€…
          for author in $AUTHORS; do
            echo "Scanning modules for author: $author"
            
            # æ ¸å¿ƒä¿®æ”¹ï¼šåªæ‰«æ Modules/Surge/$author ç›®å½•
            # -maxdepth 1 ç¡®ä¿ä¸æ‰«æå­ç›®å½•ï¼ˆå¦‚ Betaï¼‰ï¼Œåªå¤„ç†æ ¹ç›®å½•ä¸‹çš„æ­£å¼ç‰ˆæ–‡ä»¶
            find "Modules/Surge/$author" -maxdepth 1 -type f -name "*.sgmodule" | while read sgmodule_file; do
              
              module_folder=$(basename "$sgmodule_file" .sgmodule)
              
              # æå– JS é“¾æ¥ (ä¸é™å…³é”®è¯ï¼ŒåŒ¹é…æ‰€æœ‰ http js)
              js_links=$(grep -v '#' "$sgmodule_file" | grep -oP 'https?://[^ \"\)]+\.(json|js|jq)' || echo "")
              
              if [ -z "$js_links" ]; then continue; fi

              echo "Processing JS links for $module_folder..."

              for js_link in $js_links; do
                js_filename=$(basename "$js_link")
                local_js_path="Modules/JS/$author/$module_folder/$js_filename"
                github_js_url="$js_base_url/$author/$module_folder/$js_filename"
   
                mkdir -p "$(dirname "$local_js_path")"

                if curl -sL -A "Surge Mac/2985" -o "$local_js_path" "$js_link"; then
                  
                  escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
                  
                  # æ‰¹é‡æ›¿æ¢ï¼šé™åˆ¶åœ¨å½“å‰ä½œè€…ç›®å½•ä¸‹æŸ¥æ‰¾ç›¸å…³æ–‡ä»¶
                  find "Modules" -path "*/$author/*" \( -name "${module_folder}.sgmodule" -o -name "${module_folder}.lpx" -o -name "${module_folder}.srmodule" \) | \
                  xargs -I {} sed -i "s|$escaped_link|$github_js_url|g" "{}"
                  
                fi
              done
            done
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          git add Modules/*
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MESSAGE="Converted modules at $DATE (UTC+8)"
            git stash
            git pull --rebase --autostash || true
            git stash pop || true
            git add Modules/*
            git commit -m "$COMMIT_MESSAGE"
            git push
          fi
