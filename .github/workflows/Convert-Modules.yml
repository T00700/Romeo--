name: Extract and Process Modules

on:
  schedule:
    - cron: '0,30 * * * *'
  workflow_dispatch:

jobs:
  Converting:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      # ä¼˜åŒ–1: ç§»é™¤ apt-get install

      - name: Wait for Docker services to be ready
        run: |
          echo "Waiting for Docker services to be ready..."
          timeout 60 bash -c 'until nc -z localhost 9100 && nc -z localhost 9101; do sleep 1; done'

      - name: Process Links and Download Files
        run: |
          category="Jacob"
          encoded_category=$(echo "$category" | jq -sRr @uri)
          
          while read -r module_link; do
            if [[ "$module_link" =~ ^\s*#.* ]] || [[ -z "${module_link// }" ]]; then
              continue
            fi
            
            encoded_module_link=$(echo "$module_link" | sed 's/ðŸ˜‚/%F0%9F%98%82/g')
            author=$(echo "$module_link" | cut -d'/' -f4)
            filename_noext=$(basename "$module_link" | sed 's/\(.*\)\..*/\1/')
            encoded_filename=$(echo "$filename_noext" | jq -sRr @uri)
            
            mkdir -p Modules/{Surge,Loon,Shadowrocket}/$author/Beta
            mkdir -p Modules/JS/$author/Beta

            Surge_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.sgmodule?type=surge-module&target=surge-module&category=${encoded_category}&nore=true"
            Surge_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.sgmodule?type=surge-module&target=surge-module&category=${encoded_category}&nore=true&jqEnabled=true"
            Loon_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true"
            Loon_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true&jqEnabled=true"
            Shadowrocket_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.srmodule?type=surge-module&target=shadowrocket-module&category=${encoded_category}&nore=true"
            Shadowrocket_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.srmodule?type=surge-module&target=shadowrocket-module&category=${encoded_category}&nore=true&jqEnabled=true"

            echo "Processing $filename_noext by $author..."

            # ä¸²è¡Œä¸‹è½½
            curl -A "Surge Mac/2985" -L -o "Modules/Surge/$author/$filename_noext.sgmodule" "$Surge_url" || echo "Failed Surge Official"
            curl -A "Surge Mac/2985" -L -o "Modules/Surge/$author/Beta/$filename_noext.sgmodule" "$Surge_Beta_url" || echo "Failed Surge Beta"
            curl -A "Surge Mac/2985" -L -o "Modules/Loon/$author/$filename_noext.lpx" "$Loon_url" || echo "Failed Loon Official"
            curl -A "Surge Mac/2985" -L -o "Modules/Loon/$author/Beta/$filename_noext.lpx" "$Loon_Beta_url" || echo "Failed Loon Beta"
            curl -A "Surge Mac/2985" -L -o "Modules/Shadowrocket/$author/$filename_noext.srmodule" "$Shadowrocket_url" || echo "Failed Shadowrocket Official"
            curl -A "Surge Mac/2985" -L -o "Modules/Shadowrocket/$author/Beta/$filename_noext.srmodule" "$Shadowrocket_Beta_url" || echo "Failed Shadowrocket Beta"
            
          done < Links/Modules-Links.txt

      # ä¼˜åŒ–ï¼šç§»é™¤äº† Collect authors æ­¥éª¤ï¼Œå› ä¸ºä¸‹ä¸€æ­¥ç›´æŽ¥ä»Žæ–‡ä»¶è·¯å¾„èŽ·å–ä½œè€…æ›´å‡†ç¡®

      - name: Find and replace external JS resources
        continue-on-error: true
        run: |
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"
          
          # éåŽ† Modules/Surge ä¸‹çš„æ‰€æœ‰ .sgmodule æ–‡ä»¶ (æŽ’é™¤ Beta ç›®å½•)
          find Modules/Surge -type f -name "*.sgmodule" -not -path "*/Beta/*" | while read sgmodule_file; do
            
            # åŠ¨æ€æå–ä½œè€…å (è·¯å¾„æ ¼å¼: Modules/Surge/AuthorName/File.sgmodule)
            author=$(echo "$sgmodule_file" | awk -F/ '{print $3}')
            module_folder=$(basename "$sgmodule_file" .sgmodule)
            
            # æå–æ‰€æœ‰ JS é“¾æŽ¥ (ä¸é™å…³é”®è¯)
            js_links=$(grep -v '#' "$sgmodule_file" | grep -oP 'https?://[^ \"\)]+\.(json|js|jq)' || echo "")
            
            if [ -z "$js_links" ]; then continue; fi

            echo "Processing JS for $author / $module_folder..."

            for js_link in $js_links; do
              js_filename=$(basename "$js_link")
              local_js_path="Modules/JS/$author/$module_folder/$js_filename"
              github_js_url="$js_base_url/$author/$module_folder/$js_filename"
   
              mkdir -p "$(dirname "$local_js_path")"

              if curl -sL -A "Surge Mac/2985" -o "$local_js_path" "$js_link"; then
                
                escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
                
                # æ‰¹é‡æ›¿æ¢ï¼šåªæŸ¥æ‰¾å½“å‰ä½œè€…($author)ç›®å½•ä¸‹çš„ç›¸å…³æ–‡ä»¶
                find Modules -path "*/$author/*" \( -name "${module_folder}.sgmodule" -o -name "${module_folder}.lpx" -o -name "${module_folder}.srmodule" \) | \
                xargs -I {} sed -i "s|$escaped_link|$github_js_url|g" "{}"
                
              fi
            done
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          git add Modules/*
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MESSAGE="Converted modules at $DATE (UTC+8)"
            git stash
            git pull --rebase --autostash || true
            git stash pop || true
            git add Modules/*
            git commit -m "$COMMIT_MESSAGE"
            git push
          fi
