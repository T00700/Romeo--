name: Extract and Process Modules

on:
  schedule:
    - cron: '0,30 * * * *'
  workflow_dispatch:

jobs:
  Converting:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      - name: Wait for Docker services to be ready
        run: |
          echo "Waiting for Docker services..."
          timeout 60 bash -c 'until nc -z localhost 9100 && nc -z localhost 9101; do sleep 1; done'

      # === æ ¸å¿ƒæ­¥éª¤ï¼šè§£æã€ä¸‹è½½å¤‡ä»½ã€ç”Ÿæˆå»é‡åçš„è½¬æ¢åˆ—è¡¨ ===
      - name: Analyze, Download and Deduplicate
        id: prepare_list
        run: |
          # å®šä¹‰éœ€è¦è½¬æ¢çš„é“¾æ¥åˆ—è¡¨æ–‡ä»¶
          CONVERT_LIST="convert_tasks.txt"
          touch "$CONVERT_LIST"
          
          # å®šä¹‰å…³è”æ•°ç»„ç”¨äºå»é‡: key="author/filename"
          declare -A seen_modules

          # é€è¡Œè¯»å–é“¾æ¥æ–‡ä»¶
          while read -r url; do
            # è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
            if [[ "$url" =~ ^\s*#.* ]] || [[ -z "${url// }" ]]; then
              continue
            fi

            # 1. è§£æä¿¡æ¯
            # å‡è®¾ URL ç»“æ„ä¸­ç¬¬ 4 éƒ¨åˆ†æ˜¯ä½œè€… (github.com/Author/Repo...)
            author=$(echo "$url" | cut -d'/' -f4)
            filename_full=$(basename "$url")
            # ç§»é™¤æ‰€æœ‰åç¼€è·å–ä¸»æ–‡ä»¶å (ä¾‹å¦‚ bilibili.sgmodule -> bilibili)
            # ä½¿ç”¨ä¸¤æ¬¡æ›¿æ¢ä»¥é˜²æœ‰ç±»ä¼¼ .plugin.sgmodule çš„æƒ…å†µï¼Œæˆ–è€…ç®€å•å¤„ç†
            filename_noext="${filename_full%.*}"
            extension="${filename_full##*.}"

            # 2. æ ¹æ®åç¼€ä¸‹è½½åˆ° Official ç›®å½• (å¤‡ä»½é€»è¾‘)
            # æ³¨æ„ï¼šè¿™é‡Œåªä¸‹è½½ï¼Œä¸è½¬æ¢
            save_dir=""
            case "$extension" in
              sgmodule)
                save_dir="Modules/Surge/$author/Official"
                ;;
              lpx|plugin)
                save_dir="Modules/Loon/$author/Official"
                ;;
              *)
                # å…¶ä»–æ ¼å¼ (js, conf, snippet) ä¸ä¿å­˜åˆ° Officialï¼Œç›´æ¥è·³è¿‡ä¸‹è½½æ­¥éª¤ï¼Œè¿›å…¥å»é‡é€»è¾‘
                ;;
            esac

            if [[ -n "$save_dir" ]]; then
              mkdir -p "$save_dir"
              echo "ğŸ“¥ Downloading backup: $filename_full -> $save_dir"
              curl -sL -A "Surge Mac/2985" -o "$save_dir/$filename_full" "$url" || echo "   âŒ Backup failed"
            fi

            # 3. æ™ºèƒ½å»é‡å¹¶æ·»åŠ åˆ°è½¬æ¢åˆ—è¡¨
            # å”¯ä¸€æ ‡è¯†ç¬¦: ä½œè€…/æ–‡ä»¶å (ä¸å«åç¼€)
            unique_key="${author}/${filename_noext}"

            if [[ -z "${seen_modules[$unique_key]}" ]]; then
              # å¦‚æœæ²¡é‡åˆ°è¿‡è¿™ä¸ªæ¨¡å—ï¼ŒåŠ å…¥è½¬æ¢åˆ—è¡¨
              echo "$url" >> "$CONVERT_LIST"
              seen_modules["$unique_key"]=1
              echo "   âœ… Added to conversion queue: $unique_key ($extension)"
            else
              # å¦‚æœé‡åˆ°è¿‡ï¼Œè¯´æ˜æ˜¯åŒåä¸åŒæ ¼å¼ï¼ˆå¦‚ bilibili.lpx å’Œ bilibili.sgmoduleï¼‰
              # å› ä¸ºå·²ç»å¤‡ä»½äº†æ–‡ä»¶ï¼Œè¿™é‡Œä¸éœ€è¦å†æ¬¡æ·»åŠ åˆ°è½¬æ¢åˆ—è¡¨
              echo "   â© Duplicate module detected, skipping conversion: $unique_key"
            fi

          done < Links/Modules-Links.txt

      # === ä¸²è¡Œè½¬æ¢ ===
      - name: Convert Modules (Serialized)
        run: |
          category="Jacob"
          encoded_category=$(echo "$category" | jq -sRr @uri)
          
          # è¯»å–å»é‡åçš„ä»»åŠ¡åˆ—è¡¨
          if [ ! -f convert_tasks.txt ]; then
            echo "No tasks found."
            exit 0
          fi

          while read -r module_link; do
            [ -z "$module_link" ] && continue

            # è§£æä¿¡æ¯
            encoded_module_link=$(echo "$module_link" | sed 's/ğŸ˜‚/%F0%9F%98%82/g')
            author=$(echo "$module_link" | cut -d'/' -f4)
            filename_full=$(basename "$module_link")
            filename_noext="${filename_full%.*}"
            encoded_filename=$(echo "$filename_noext" | jq -sRr @uri)

            # åˆ›å»º Beta ç›®å½•
            mkdir -p Modules/{Surge,Loon,Shadowrocket}/$author/Beta

            # æ„é€  URL
            Surge_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.sgmodule?type=surge-module&target=surge-module&category=${encoded_category}&nore=true"
            Surge_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.sgmodule?type=surge-module&target=surge-module&category=${encoded_category}&nore=true&jqEnabled=true"
            Loon_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true"
            Loon_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true&jqEnabled=true"
            Shadowrocket_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.srmodule?type=surge-module&target=shadowrocket-module&category=${encoded_category}&nore=true"
            Shadowrocket_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.srmodule?type=surge-module&target=shadowrocket-module&category=${encoded_category}&nore=true&jqEnabled=true"

            echo "ğŸ”„ Converting: $filename_noext ($author)"

            # æ‰§è¡Œä¸‹è½½ (ä¸²è¡Œ)
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/$author/Beta/$filename_noext.sgmodule" "$Surge_Beta_url"
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/$author/Beta/$filename_noext.lpx" "$Loon_Beta_url"
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/$author/Beta/$filename_noext.srmodule" "$Shadowrocket_Beta_url"
            
            # æ­£å¼ç‰ˆè½¬æ¢ (Official)
            # æ³¨æ„ï¼šåªæœ‰ Beta ç‰ˆå¼ºåˆ¶æ”¾åœ¨ Beta ç›®å½•ã€‚
            # æ­£å¼ç‰ˆè½¬æ¢é€šå¸¸ä¸éœ€è¦å­˜æ–‡ä»¶ï¼Œå› ä¸ºå¦‚æœæ˜¯ sgmodule/lpx æˆ‘ä»¬å·²ç»å¤‡ä»½äº†åŸæ–‡ä»¶ã€‚
            # ä½†å¦‚æœä½ éœ€è¦ç”Ÿæˆâ€œè·¨å¹³å°â€çš„æ­£å¼ç‰ˆï¼ˆä¾‹å¦‚ç”¨ sgmodule ç”Ÿæˆ srmoduleï¼‰ï¼Œåˆ™éœ€è¦ä¸‹è½½ï¼š
            
            # ç”Ÿæˆ Surge æ­£å¼ç‰ˆ (å¦‚æœåŸæ–‡ä»¶ä¸æ˜¯ sgmoduleï¼Œè¿™é‡Œä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ï¼›å¦‚æœæ˜¯ï¼Œåˆ™è¦†ç›–æˆ–å¿½ç•¥)
            # è¿™é‡Œç»Ÿä¸€ç”Ÿæˆåˆ° Surge/$author/Beta/.. ä¼¼ä¹ä¸å¯¹ï¼Œåº”è¯¥æ ¹æ®éœ€æ±‚ã€‚
            # é€šå¸¸ Logic: Official å­˜åŸæ–‡ä»¶ï¼ŒBeta å­˜è½¬æ¢åçš„æ–‡ä»¶ã€‚
            # ä½†æ—¢ç„¶æ˜¯è½¬æ¢ï¼ŒShadowrocket ç”¨æˆ·éœ€è¦ srmoduleã€‚
            
            # ä¸ºäº†ç®€å•ä¸”ç¬¦åˆä½ ä¹‹å‰çš„é€»è¾‘ï¼Œè¿™é‡Œç”Ÿæˆä¸€ä»½â€œéBetaâ€çš„è½¬æ¢ç‰ˆåˆ°æ ¹ç›®å½•ï¼Ÿ
            # æˆ–è€…ç›´æ¥ç”Ÿæˆåˆ°å¯¹åº”çš„ Official ç›®å½•ï¼Ÿ(ä¸å»ºè®®ï¼Œå› ä¸º Official å­˜çš„æ˜¯åŸæ±åŸå‘³çš„æ–‡ä»¶)
            # è¿™é‡Œæˆ‘æŒ‰ç…§ä½ ä¹‹å‰çš„é€»è¾‘ï¼Œç”Ÿæˆåˆ° Modules/Platform/Author/ ä¸‹ (ä¸å¸¦Beta)
            
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/$author/$filename_noext.sgmodule" "$Surge_url"
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/$author/$filename_noext.lpx" "$Loon_url"
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/$author/$filename_noext.srmodule" "$Shadowrocket_url"

          done < convert_tasks.txt

      # === JS æ›¿æ¢ ===
      - name: Find and replace external JS resources
        continue-on-error: true
        run: |
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"
          mkdir -p Modules/JS

          # è·å–æ‰€æœ‰æ¶‰åŠçš„ä½œè€…åˆ—è¡¨ (ä» Modules ç›®å½•è¯»å–)
          # find Modules/Surge -mindepth 1 -maxdepth 1 -type d
          
          # éå† Modules ç›®å½•ä¸‹çš„æ‰€æœ‰ .sgmodule, .lpx, .srmodule æ–‡ä»¶
          # åŒ…æ‹¬ Official å’Œ Beta
          find Modules -type f \( -name "*.sgmodule" -o -name "*.lpx" -o -name "*.srmodule" \) | while read file; do
            
            # æå–ä½œè€… (è·¯å¾„ç¬¬3å±‚: Modules/Surge/Author/...)
            author=$(echo "$file" | cut -d'/' -f3)
            module_name=$(basename "$file")
            
            # æå– JS é“¾æ¥
            js_links=$(grep -v '#' "$file" | grep -oP 'https?://[^ \"\)]+\.(json|js|jq)' || echo "")
            
            if [ -z "$js_links" ]; then continue; fi
            
            # echo "Found JS in $file"

            for js_link in $js_links; do
              js_filename=$(basename "$js_link")
              local_js_path="Modules/JS/$author/${module_name%.*}/$js_filename"
              github_js_url="$js_base_url/$author/${module_name%.*}/$js_filename"
              
              # åªè¦æœ‰ä¸€ä¸ªæ–‡ä»¶éœ€è¦è¿™ä¸ª JSï¼Œå°±ä¸‹è½½å®ƒ
              if [ ! -f "$local_js_path" ]; then
                 mkdir -p "$(dirname "$local_js_path")"
                 if curl -sL -A "Surge Mac/2985" -o "$local_js_path" "$js_link"; then
                    # echo "  Downloaded $js_filename"
                    :
                 else
                    echo "  âŒ Failed download: $js_link"
                    continue
                 fi
              fi
              
              # æ‰§è¡Œæ›¿æ¢ (å¯¹å½“å‰æ–‡ä»¶)
              escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
              sed -i "s|$escaped_link|$github_js_url|g" "$file"
            done
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          git add Modules/*
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f convert_tasks.txt
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MESSAGE="Converted modules at $DATE (UTC+8)"
            git stash
            git pull --rebase --autostash || true
            git stash pop || true
            git add Modules/*
            git commit -m "$COMMIT_MESSAGE"
            git push
          fi
