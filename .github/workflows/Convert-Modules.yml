name: Extract and Process Modules

on:
  schedule:
    - cron: '0,30 * * * *'
  workflow_dispatch:

jobs:
  Converting:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      - name: Wait for Docker services to be ready
        run: |
          echo "Waiting for Docker services to be ready..."
          timeout 60 bash -c 'until nc -z localhost 9100 && nc -z localhost 9101; do sleep 1; done'

      # =================================================================
      # æ ¸å¿ƒä¿®æ”¹æ­¥éª¤ï¼šåˆ†æµä¸‹è½½å¹¶æ”¶é›†è½¬æ¢æº
      # =================================================================
      - name: Process Links, Download Files, and Collect Conversion Sources
        run: |
          category="Jacob"
          encoded_category=$(echo "$category" | jq -sRr @uri)
          # ç”¨äºæ”¶é›†éœ€è¦ Docker è½¬æ¢çš„å”¯ä¸€é“¾æ¥
          TARGET_MODULES_FILE="Links/Conversion-Sources.txt"
          > $TARGET_MODULES_FILE
          
          while read -r module_link; do
            if [[ "$module_link" =~ ^\s*#.* ]] || [[ -z "${module_link// }" ]]; then
              continue
            fi
            
            # --- 1. è§£æé“¾æ¥ ---
            file_ext="${module_link##*.}"
            author=$(echo "$module_link" | cut -d'/' -f4)
            filename_noext=$(basename "$module_link" | sed 's/\(.*\)\..*/\1/')
            
            # ç¡®å®šå­˜å‚¨è·¯å¾„å’Œç›®æ ‡è½¬æ¢æ ¼å¼
            target_platform=""
            target_ext=""
            
            case "$file_ext" in
              sgmodule)
                target_platform="Surge"
                target_ext=".sgmodule"
                ;;
              lpx|plugin)
                target_platform="Loon"
                # å³ä½¿æ˜¯ .pluginï¼Œä¹Ÿå°†å…¶ä¸‹è½½ä¸º Loon çš„æ ‡å‡† .lpx æ ¼å¼
                target_ext=".lpx" 
                ;;
              *)
                echo "âš ï¸ Skipping unsupported file type: $file_ext"
                continue
                ;;
            esac
            
            # ç¡®å®šå­˜å‚¨ç›®å½•
            storage_dir="Modules/$target_platform/$author/Official"
            mkdir -p "$storage_dir"
            mkdir -p Modules/{Surge,Loon,Shadowrocket}/$author/Beta
            mkdir -p Modules/JS/$author/Beta

            encoded_module_link=$(echo "$module_link" | sed 's/ğŸ˜‚/%F0%9F%98%82/g')
            encoded_filename=$(echo "$filename_noext" | jq -sRr @uri)
            
            # --- 2. æ„é€ ä¸‹è½½ URL ---
            # å¯¹äº Surge æ¨¡å—ï¼Œä½¿ç”¨ Surge/Loon/Shadowrocket çš„å®˜æ–¹ç‰ˆè½¬æ¢
            # å¯¹äº Loon æ’ä»¶ï¼Œåªä½¿ç”¨ Loon çš„å®˜æ–¹ç‰ˆè½¬æ¢
            
            if [ "$target_platform" == "Surge" ]; then
                # Surge æºçš„è½¬æ¢ URL (ä½¿ç”¨ 9100 ç«¯å£è·å– Official ç‰ˆæœ¬)
                official_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}${target_ext}?type=surge-module&target=surge-module&category=${encoded_category}&nore=true"
                beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}${target_ext}?type=surge-module&target=surge-module&category=${encoded_category}&nore=true&jqEnabled=true"
            elif [ "$target_platform" == "Loon" ]; then
                # Loon æºçš„è½¬æ¢ URL (ä½¿ç”¨ 9100 ç«¯å£è·å– Official ç‰ˆæœ¬)
                official_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true"
                beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.lpx?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true&jqEnabled=true"
            fi
            
            # --- 3. ä¸‹è½½åˆ° Official ç›®å½• ---
            echo "Processing $filename_noext by $author ($target_platform)..."
            curl -A "Surge Mac/2985" -L -o "$storage_dir/$filename_noext$target_ext" "$official_url" || echo "Failed Official Download for $target_platform"
            
            # --- 4. æ”¶é›†å”¯ä¸€è½¬æ¢æº ---
            # æ ¼å¼ï¼š<ä½œè€…>/<æ–‡ä»¶å>.<åŸå§‹åç¼€>
            # è¿™ä¸€æ­¥æ˜¯ä¸ºäº†åç»­çš„ Docker è½¬æ¢æ­¥éª¤å»é‡
            echo "$author/$filename_noext.$file_ext" >> $TARGET_MODULES_FILE
            
          done < Links/Modules-Links.txt
          
          # å¯¹æ”¶é›†åˆ°çš„æ–‡ä»¶è¿›è¡Œå»é‡
          sort -u $TARGET_MODULES_FILE -o $TARGET_MODULES_FILE

      # =================================================================
      # æ–°å¢æ­¥éª¤ï¼šåŸºäºæ”¶é›†åˆ°çš„æºæ–‡ä»¶ï¼Œè¿›è¡Œåç»­å¹³å°è½¬æ¢
      # =================================================================
      - name: Perform Cross-Platform Conversion and Beta Download
        run: |
          category="Jacob"
          encoded_category=$(echo "$category" | jq -sRr @uri)
          TARGET_MODULES_FILE="Links/Conversion-Sources.txt"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œé˜²æ­¢ç©ºè·‘
          if [ ! -f $TARGET_MODULES_FILE ] || [ ! -s $TARGET_MODULES_FILE ]; then
              echo "No unique conversion sources collected. Skipping conversion."
              exit 0
          fi

          while read -r source_path; do
            # source_path æ ¼å¼å¦‚ï¼šauthor/filename.ext
            author=$(echo "$source_path" | cut -d'/' -f1)
            filename=$(basename "$source_path")
            filename_noext="${filename%.*}"
            file_ext="${filename##*.}"

            if [ "$file_ext" == "sgmodule" ]; then
                # Surge æº (Official) è½¬æ¢
                platform_dir="Surge"
                base_link="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/Surge/$author/Official/${filename_noext}.sgmodule"
                type="surge-module"
                source_ext=".sgmodule"
                target_sgmodule=".sgmodule"
                target_lpx=".lpx"
                target_srmodule=".srmodule"
            elif [ "$file_ext" == "lpx" ] || [ "$file_ext" == "plugin" ]; then
                # Loon æº (Official) è½¬æ¢
                platform_dir="Loon"
                base_link="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/Loon/$author/Official/${filename_noext}.lpx"
                type="loon-plugin"
                source_ext=".lpx"
                target_sgmodule=".sgmodule"
                target_lpx=".lpx"
                target_srmodule=".srmodule"
            else
                continue
            fi

            encoded_base_link=$(echo "$base_link" | sed 's/ğŸ˜‚/%F0%9F%98%82/g')
            encoded_filename=$(echo "$filename_noext" | jq -sRr @uri)
            
            echo "Converting unique source: $source_path (Base Link: $base_link)"

            # === Docker Conversion URLs ===
            # Surge (Official/Beta)
            S_url="http://localhost:9100/file/_start_/${encoded_base_link}/_end_/${encoded_filename}${target_sgmodule}?type=${type}&target=surge-module&category=${encoded_category}&nore=true"
            S_Beta_url="http://localhost:9101/file/_start_/${encoded_base_link}/_end_/${encoded_filename}${target_sgmodule}?type=${type}&target=surge-module&category=${encoded_category}&nore=true&jqEnabled=true"
            
            # Loon (Official/Beta)
            L_url="http://localhost:9100/file/_start_/${encoded_base_link}/_end_/${encoded_filename}${target_lpx}?type=${type}&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true"
            L_Beta_url="http://localhost:9101/file/_start_/${encoded_base_link}/_end_/${encoded_filename}${target_lpx}?type=${type}&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true&jqEnabled=true"
            
            # Shadowrocket (Official/Beta)
            SR_url="http://localhost:9100/file/_start_/${encoded_base_link}/_end_/${encoded_filename}${target_srmodule}?type=${type}&target=shadowrocket-module&category=${encoded_category}&nore=true"
            SR_Beta_url="http://localhost:9101/file/_start_/${encoded_base_link}/_end_/${encoded_filename}${target_srmodule}?type=${type}&target=shadowrocket-module&category=${encoded_category}&nore=true&jqEnabled=true"


            # === æ‰§è¡Œä¸‹è½½ï¼ˆä»…é™è·¨å¹³å°å’Œ Beta ç‰ˆæœ¬ï¼‰===
            curl -A "Surge Mac/2985" -L -o "Modules/Surge/$author/$filename_noext${target_sgmodule}" "$S_url" || echo "Failed Surge Official"
            curl -A "Surge Mac/2985" -L -o "Modules/Surge/$author/Beta/$filename_noext${target_sgmodule}" "$S_Beta_url" || echo "Failed Surge Beta"
            
            curl -A "Surge Mac/2985" -L -o "Modules/Loon/$author/$filename_noext${target_lpx}" "$L_url" || echo "Failed Loon Official"
            curl -A "Surge Mac/2985" -L -o "Modules/Loon/$author/Beta/$filename_noext${target_lpx}" "$L_Beta_url" || echo "Failed Loon Beta"
            
            curl -A "Surge Mac/2985" -L -o "Modules/Shadowrocket/$author/$filename_noext${target_srmodule}" "$SR_url" || echo "Failed Shadowrocket Official"
            curl -A "Surge Mac/2985" -L -o "Modules/Shadowrocket/$author/Beta/$filename_noext${target_srmodule}" "$SR_Beta_url" || echo "Failed Shadowrocket Beta"

          done < $TARGET_MODULES_FILE


      # æ”¶é›†ä½œè€…åˆ—è¡¨ (ä¿ç•™ï¼Œä¾› JS æ›¿æ¢ä½¿ç”¨)
      - name: Collect authors
        run: |
          authors=$(grep -E '^https?://' Links/Modules-Links.txt | cut -d'/' -f4 | sort -u | tr '\n' ' ')
          echo "AUTHORS=$authors" >> $GITHUB_ENV

      # JS æ›¿æ¢é€»è¾‘ä¸å˜ï¼Œå› ä¸ºåªéœ€æ‰«æ Modules/Surge/$author ç›®å½•
      - name: Find and replace external JS resources
        continue-on-error: true
        run: |
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"

          for author in $AUTHORS; do
            echo "Scanning modules for author: $author"
            
            # æ‰«æ Official ç›®å½•ä¸‹çš„ .sgmodule æ–‡ä»¶
            find "Modules/Surge/$author/Official" -maxdepth 1 -type f -name "*.sgmodule" | while read sgmodule_file; do
              
              module_folder=$(basename "$sgmodule_file" .sgmodule)
              
              js_links=$(grep -v '#' "$sgmodule_file" | grep -oP 'https?://[^ \"\)]+\.(json|js|jq)' || echo "")
              
              if [ -z "$js_links" ]; then continue; fi

              echo "Processing JS links for $module_folder..."

              for js_link in $js_links; do
                js_filename=$(basename "$js_link")
                local_js_path="Modules/JS/$author/$module_folder/$js_filename"
                github_js_url="$js_base_url/$author/$module_folder/$js_filename"
   
                mkdir -p "$(dirname "$local_js_path")"

                if curl -sL -A "Surge Mac/2985" -o "$local_js_path" "$js_link"; then
                  
                  escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
                  
                  # æ‰¹é‡æ›¿æ¢ï¼šé™åˆ¶åœ¨å½“å‰ä½œè€…ç›®å½•ä¸‹æŸ¥æ‰¾ç›¸å…³æ–‡ä»¶ (SG/LPX/SR)
                  find "Modules" -path "*/$author/*" \( -name "${module_folder}.sgmodule" -o -name "${module_folder}.lpx" -o -name "${module_folder}.srmodule" \) | \
                  xargs -I {} sed -i "s|$escaped_link|$github_js_url|g" "{}"
                  
                fi
              done
            done
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          git add Modules/*
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          if [ -f "Links/Conversion-Sources.txt" ]; then
              rm "Links/Conversion-Sources.txt"
          fi
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MESSAGE="Converted modules at $DATE (UTC+8)"
            git stash
            git pull --rebase --autostash || true
            git stash pop || true
            git add Modules/*
            git commit -m "$COMMIT_MESSAGE"
            git push
          fi
