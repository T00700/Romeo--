name: Extract and Process Modules

on:
  schedule:
    - cron: '0,30 * * * *'
  workflow_dispatch:

jobs:
  Converting:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      - name: Wait for Docker services to be ready
        run: |
          echo "Waiting for Docker services..."
          timeout 60 bash -c 'until nc -z localhost 9100 && nc -z localhost 9101; do sleep 1; done'

      # === æ ¸å¿ƒæ­¥éª¤ï¼šä¸‹è½½å¤‡ä»½ + æ™ºèƒ½å»é‡ ===
      - name: Download, Backup and Generate Task List
        run: |
          # 1. å‡†å¤‡å·¥ä½œ
          CONVERT_LIST="convert_tasks.txt"
          touch "$CONVERT_LIST"
          
          # å®šä¹‰å…³è”æ•°ç»„ç”¨äºå»é‡: key="author/filename"
          declare -A seen_modules

          echo "ğŸ” Scanning links..."

          # 2. é€è¡Œè¯»å–é“¾æ¥
          while read -r url; do
            # è·³è¿‡æ— æ•ˆè¡Œ
            if [[ "$url" =~ ^\s*#.* ]] || [[ -z "${url// }" ]]; then continue; fi

            # è§£æå…ƒæ•°æ®
            # å‡è®¾ URL ç»“æ„: .../Author/Repo/.../filename.ext
            # è¿™é‡Œå–ç¬¬4æ®µä½œä¸ºä½œè€…åï¼Œè¿™å–å†³äº github raw é“¾æ¥çš„æ ‡å‡†æ ¼å¼
            # https://github.com/kokoryh/Sparkle/raw/... -> kokoryh
            author=$(echo "$url" | cut -d'/' -f4)
            filename_full=$(basename "$url")
            # å»é™¤åç¼€è·å–ä¸»æ–‡ä»¶å (bilibili.sgmodule -> bilibili)
            filename_noext="${filename_full%.*}"
            extension="${filename_full##*.}"

            # ==========================================
            # é˜¶æ®µ A: ä¸‹è½½å¤‡ä»½ (Backup to Official)
            # ==========================================
            target_dir=""
            
            if [[ "$extension" == "sgmodule" ]]; then
              target_dir="Modules/Surge/$author/Official"
            elif [[ "$extension" == "lpx" || "$extension" == "plugin" ]]; then
              target_dir="Modules/Loon/$author/Official"
            fi

            # å¦‚æœéœ€è¦å¤‡ä»½ï¼Œåˆ™æ‰§è¡Œä¸‹è½½
            if [[ -n "$target_dir" ]]; then
              # æ˜¾å¼åˆ›å»ºæ–‡ä»¶å¤¹ !!
              mkdir -p "$target_dir"
              
              echo "ğŸ“¥ Backup: $filename_full -> $target_dir"
              curl -sL -A "Surge Mac/2985" -o "$target_dir/$filename_full" "$url" || echo "   âŒ Backup failed"
            fi

            # ==========================================
            # é˜¶æ®µ B: ç”Ÿæˆè½¬æ¢åˆ—è¡¨ (Deduplication)
            # ==========================================
            unique_key="${author}/${filename_noext}"

            # æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡åŒååŒä½œè€…çš„æ¨¡å—
            if [[ -z "${seen_modules[$unique_key]}" ]]; then
              # === ç¬¬ä¸€æ¬¡é‡åˆ°ï¼šåŠ å…¥è½¬æ¢åˆ—è¡¨ ===
              echo "$url" >> "$CONVERT_LIST"
              seen_modules["$unique_key"]=1
              echo "   âœ… Added to conversion queue: $unique_key"
            else
              # === å·²é‡åˆ°è¿‡ï¼šè·³è¿‡è½¬æ¢ ===
              # (æ³¨æ„ï¼šä¸Šé¢çš„ä¸‹è½½å¤‡ä»½æ­¥éª¤å·²ç»æ‰§è¡Œè¿‡äº†ï¼Œæ‰€ä»¥æ–‡ä»¶ä¼šå­˜åœ¨ï¼Œåªæ˜¯ä¸é‡å¤æ¶ˆè€—èµ„æºå»è½¬æ¢)
              echo "   â© Skipped duplicate conversion: $unique_key (Source: $extension)"
            fi

          done < Links/Modules-Links.txt

      # === ä¸²è¡Œè½¬æ¢ ===
      - name: Convert Modules (Serialized)
        run: |
          category="Jacob"
          encoded_category=$(echo "$category" | jq -sRr @uri)
          
          if [ ! -s convert_tasks.txt ]; then
            echo "No tasks found."
            exit 0
          fi

          while read -r module_link; do
            [ -z "$module_link" ] && continue

            encoded_module_link=$(echo "$module_link" | sed 's/ğŸ˜‚/%F0%9F%98%82/g')
            author=$(echo "$module_link" | cut -d'/' -f4)
            filename_full=$(basename "$module_link")
            filename_noext="${filename_full%.*}"
            encoded_filename=$(echo "$filename_noext" | jq -sRr @uri)
            
            # ç¡®å®šåŸå§‹ç±»å‹ (ç”¨äº type å‚æ•°)
            ext="${filename_full##*.}"
            if [[ "$ext" == "sgmodule" ]]; then
               src_type="surge-module"
            elif [[ "$ext" == "lpx" || "$ext" == "plugin" ]]; then
               src_type="loon-plugin"
            else
               # é»˜è®¤ä¸º surge-module æˆ–è€…æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
               src_type="surge-module" 
            fi

            # åˆ›å»º Beta ç›®å½• (Official ç›®å½•åœ¨ä¸Šä¸€æ­¥å·²ç»æŒ‰éœ€åˆ›å»ºäº†)
            mkdir -p Modules/{Surge,Loon,Shadowrocket}/$author/Beta

            # æ„é€  URL (æ³¨æ„ type å‚æ•°ä½¿ç”¨äº†åŠ¨æ€å˜é‡)
            Surge_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.sgmodule?type=${src_type}&target=surge-module&category=${encoded_category}&nore=true"
            Surge_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.sgmodule?type=${src_type}&target=surge-module&category=${encoded_category}&nore=true&jqEnabled=true"
            Loon_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.lpx?type=${src_type}&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true"
            Loon_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.lpx?type=${src_type}&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true&jqEnabled=true"
            Shadowrocket_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.srmodule?type=${src_type}&target=shadowrocket-module&category=${encoded_category}&nore=true"
            Shadowrocket_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.srmodule?type=${src_type}&target=shadowrocket-module&category=${encoded_category}&nore=true&jqEnabled=true"

            echo "ğŸ”„ Converting: $filename_noext ($author)"

            # ä¸‹è½½è½¬æ¢åçš„æ–‡ä»¶
            # 1. Beta ç‰ˆæœ¬ (æ‰€æœ‰æ ¼å¼éƒ½ä¸‹è½½)
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/$author/Beta/$filename_noext.sgmodule" "$Surge_Beta_url"
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/$author/Beta/$filename_noext.lpx" "$Loon_Beta_url"
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/$author/Beta/$filename_noext.srmodule" "$Shadowrocket_Beta_url"
            
            # 2. æ­£å¼ç‰ˆæœ¬ (Official)
            # è¿™é‡Œæœ‰ä¸€ä¸ªé€»è¾‘ï¼š
            # å¦‚æœåŸæ–‡ä»¶æ˜¯ .sgmoduleï¼Œæˆ‘ä»¬å·²ç»å¤‡ä»½åœ¨ Modules/Surge/.../Official äº†ã€‚
            # ä½†æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ç”Ÿæˆå¯¹åº”çš„ Loon å’Œ Shadowrocket çš„æ­£å¼ç‰ˆã€‚
            # ä¹‹å‰ä½ çš„é€»è¾‘æ˜¯å…¨éƒ¨é‡æ–°ä¸‹è½½ä¸€éè¦†ç›–ã€‚è¿™é‡Œä¿æŒåŸé€»è¾‘ï¼Œç”Ÿæˆè·¨å¹³å°çš„æ­£å¼ç‰ˆã€‚
            # ä¸ºäº†ä¸è¦†ç›–å·²ç»å¤‡ä»½çš„â€œåŸæ±åŸå‘³â€æºæ–‡ä»¶ï¼Œä½ å¯ä»¥é€‰æ‹©ä¸ä¸‹è½½åŒæ ¼å¼çš„æ–‡ä»¶ï¼Œæˆ–è€…ä¸‹è½½è¦†ç›–ï¼ˆscript-hubè½¬æ¢åå†…å®¹å¯èƒ½å¾®è°ƒï¼‰ã€‚
            # è€ƒè™‘åˆ° script-hub ä¸»è¦æ˜¯æ ¼å¼è½¬æ¢ï¼Œä¸‹è½½è¦†ç›–é€šå¸¸æ²¡é—®é¢˜ï¼Œç”šè‡³æ›´å¥½ï¼ˆæ ‡å‡†åŒ–ï¼‰ã€‚
            
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/$author/$filename_noext.sgmodule" "$Surge_url"
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/$author/$filename_noext.lpx" "$Loon_url"
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/$author/$filename_noext.srmodule" "$Shadowrocket_url"

          done < convert_tasks.txt
          
          # æ¸…ç†ä¸´æ—¶åˆ—è¡¨
          rm -f convert_tasks.txt

      # === JS æ›¿æ¢ (ä¿æŒä¸å˜) ===
      - name: Find and replace external JS resources
        continue-on-error: true
        run: |
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"
          mkdir -p Modules/JS

          # æ‰«ææ‰€æœ‰ç›¸å…³æ–‡ä»¶ (Surge, Loon, Shadowrocket ä¸‹çš„ Official å’Œ Beta)
          find Modules -type f \( -name "*.sgmodule" -o -name "*.lpx" -o -name "*.srmodule" \) | while read file; do
            
            # æå–ä½œè€… (è·¯å¾„ç¬¬3å±‚)
            author=$(echo "$file" | cut -d'/' -f3)
            module_name=$(basename "$file")
            
            js_links=$(grep -v '#' "$file" | grep -oP 'https?://[^ \"\)]+\.(json|js|jq)' || echo "")
            
            if [ -z "$js_links" ]; then continue; fi
            
            for js_link in $js_links; do
              js_filename=$(basename "$js_link")
              local_js_path="Modules/JS/$author/${module_name%.*}/$js_filename"
              github_js_url="$js_base_url/$author/${module_name%.*}/$js_filename"
              
              if [ ! -f "$local_js_path" ]; then
                 mkdir -p "$(dirname "$local_js_path")"
                 curl -sL -A "Surge Mac/2985" -o "$local_js_path" "$js_link" || echo "  âŒ Failed download JS"
              fi
              
              escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
              sed -i "s|$escaped_link|$github_js_url|g" "$file"
            done
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          git add Modules/*
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MESSAGE="Converted modules at $DATE (UTC+8)"
            git stash
            git pull --rebase --autostash || true
            git stash pop || true
            git add Modules/*
            git commit -m "$COMMIT_MESSAGE"
            git push
          fi
