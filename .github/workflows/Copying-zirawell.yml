name: Mirror zirawell Modules

on:
  schedule:
    - cron: '7 */12 * * *'
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  Author: zirawell

jobs:
  fetch-and-convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101
      
    steps:
      - name: Checkout Target Repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Wait for Docker service
        run: |
          echo "Waiting for script-hub service..."
          timeout 60 bash -c 'until nc -z localhost 9100 && nc -z localhost 9101; do sleep 1; done'

      - name: Clone Source Repo & Prepare Files
        run: |
          git clone --depth 1 https://github.com/zirawell/R-Store.git temp_source
          
          mkdir -p Modules/Surge/${Author}/Official

          cd temp_source
          find . -type f -name "*.sgmodule" | sed 's|^\./||' > ../file_list.txt
          cd ..

          declare -A name_count
          while IFS= read -r path; do
            filename=$(basename "$path")
            name_count["$filename"]=$(( ${name_count["$filename"]} + 1 ))
          done < file_list.txt

          get_prefix() {
            local full_path="$1"
            IFS='/' read -r -a parts <<< "$full_path"
            for i in 3 2 1; do
              if [ -z "${parts[i]}" ]; then continue; fi
              dir="${parts[i]}"
              if [[ "$dir" != *".sgmodule" ]]; then
                echo "$dir"
                return
              fi
            done
            parent=$(dirname "$full_path")
            basename "$parent"
          }

          while IFS= read -r file_path; do
            filename_full=$(basename "$file_path")
            filename="${filename_full%.sgmodule}"
            count=${name_count["$filename_full"]}
            
            if [[ $count -gt 1 ]]; then
              prefix=$(get_prefix "$file_path")
              save_name="${filename}-${prefix}.sgmodule"
            else
              save_name="$filename_full"
            fi

            echo "Copying $file_path -> $save_name"
            cp "temp_source/$file_path" "Modules/Surge/${Author}/Official/$save_name"
          done < file_list.txt

          rm -rf temp_source file_list.txt

      - name: Convert sgmodules (Serialized for Stability)
        run: |
          mkdir -p Modules/Surge/${Author}/{Beta,Official} \
                   Modules/Loon/${Author}/Beta \
                   Modules/Shadowrocket/${Author}/Beta

          category="Jacob"
          encoded_category=$(echo "$category" | jq -sRr @uri)

          for file in Modules/Surge/${Author}/Official/*.sgmodule; do
            name=$(basename "$file" .sgmodule)
            encoded_name=$(echo "$name" | jq -sRr @uri)
            
            base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/Surge/${Author}/Official/$(basename "$file")"

            Surge_url="http://localhost:9100/file/_start_/${base_url}/_end_/${encoded_name}.sgmodule?type=surge-module&target=surge-module&category=${encoded_category}&nore=true"
            Surge_Beta_url="http://localhost:9101/file/_start_/${base_url}/_end_/${encoded_name}.sgmodule?type=surge-module&target=surge-module&category=${encoded_category}&nore=true"
            Loon_url="http://localhost:9100/file/_start_/${base_url}/_end_/${encoded_name}.lpx?type=surge-module&target=loon-plugin&category=${encoded_category}&nore=true"
            Loon_Beta_url="http://localhost:9101/file/_start_/${base_url}/_end_/${encoded_name}.lpx?type=surge-module&target=loon-plugin&category=${encoded_category}&nore=true"
            Shadowrocket_url="http://localhost:9100/file/_start_/${base_url}/_end_/${encoded_name}.srmodule?type=surge-module&target=shadowrocket-module&category=${encoded_category}&nore=true"
            Shadowrocket_Beta_url="http://localhost:9101/file/_start_/${base_url}/_end_/${encoded_name}.srmodule?type=surge-module&target=shadowrocket-module&category=${encoded_category}&nore=true"

            echo "Converting $name..."
            
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/${Author}/${name}.sgmodule" "$Surge_url" || echo "Failed Surge"
            curl -sL -A "Surge Mac/2985" -o "Modules/Surge/${Author}/Beta/${name}.sgmodule" "$Surge_Beta_url" || echo "Failed Surge Beta"
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/${Author}/${name}.lpx" "$Loon_url" || echo "Failed Loon"
            curl -sL -A "Surge Mac/2985" -o "Modules/Loon/${Author}/Beta/${name}.lpx" "$Loon_Beta_url" || echo "Failed Loon Beta"
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/${Author}/${name}.srmodule" "$Shadowrocket_url" || echo "Failed Shadowrocket"
            curl -sL -A "Surge Mac/2985" -o "Modules/Shadowrocket/${Author}/Beta/${name}.srmodule" "$Shadowrocket_Beta_url" || echo "Failed Shadowrocket Beta"
          done

      - name: Find and replace external JS resources
        continue-on-error: true
        run: |
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"
          mkdir -p Modules/JS/${Author}

          # 优化：只查找 Modules/Surge/${Author}，排除 Beta
          find Modules/Surge/${Author} -type f -name "*.sgmodule" -not -path "*/Beta/*" | while read module_file; do
            module_folder=$(basename "$module_file" .sgmodule)
            
            # 只提取 zirawell 的链接
            js_links=$(grep -v '#' "$module_file" | grep -oP 'https?://[^ \"\)]*zirawell[^ \"\)]+\.(json|js|jq)' || true)

            if [ -z "$js_links" ]; then continue; fi

            echo "Processing zirawell JS for $module_folder"

            for js_link in $js_links; do
              js_filename=$(basename "$js_link")
              local_js_path="Modules/JS/${Author}/$module_folder/$js_filename"
              github_js_url="$js_base_url/${Author}/$module_folder/$js_filename"
              
              mkdir -p "$(dirname "$local_js_path")"

              if curl -sL -A "Surge Mac/2985" -o "$local_js_path" "$js_link"; then
                escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
                
                find Modules -name "${module_folder}.sgmodule" -o -name "${module_folder}.lpx" -o -name "${module_folder}.srmodule" | \
                xargs -I {} sed -i "s|$escaped_link|$github_js_url|g" "{}"
                
                echo "  ✅ Replaced $js_filename"
              fi
            done
          done

      - name: Commit and push changes
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          git add Modules
          
          if git diff --cached --quiet; then
            echo "✅ No changes to commit."
          else
            COMMIT_MESSAGE="Synched Modules at $DATE (UTC+8)"
            git commit -m "$COMMIT_MESSAGE"
            git pull --rebase --autostash || true
            git push
          fi
