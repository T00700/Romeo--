name: Mirror Shadowrocket-Specific Modules

on:
  schedule:
    - cron: '0 20 * * *'  # æ¯å¤©æ‰§è¡Œä¸€æ¬¡ (åŒ—äº¬æ—¶é—´å‡Œæ™¨4ç‚¹)
  workflow_dispatch:

jobs:
  mirror-sr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    # ä¸éœ€è¦ Docker æœåŠ¡ï¼Œå› ä¸ºä¸éœ€è¦æ ¼å¼è½¬æ¢

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      # === ä»»åŠ¡ 1: å¤„ç† iab0x00 ===
      - name: Process iab0x00 (Priority Logic)
        run: |
          AUTHOR="iab0x00"
          TARGET_DIR="Modules/Shadowrocket/$AUTHOR"
          mkdir -p "$TARGET_DIR"
          
          echo "ğŸš€ Cloning $AUTHOR..."
          git clone --depth 1 -b main https://github.com/iab0x00/ProxyRules.git temp_iab
          
          # è¿›å…¥ Rewrite ç›®å½•å¤„ç†
          if [ -d "temp_iab/Rewrite" ]; then
            cd temp_iab/Rewrite
            
            # 1. å…ˆå¤åˆ¶æ‰€æœ‰çš„ .srmodule (ä¼˜å…ˆçº§é«˜)
            find . -maxdepth 1 -name "*.srmodule" | while read file; do
              cp "$file" "../../$TARGET_DIR/"
              echo "  âœ… Copied .srmodule: $file"
            done
            
            # 2. å¤„ç† .sgmodule (å¦‚æœä¸å­˜åœ¨åŒå srmodule åˆ™å¤åˆ¶)
            find . -maxdepth 1 -name "*.sgmodule" | while read file; do
              filename=$(basename "$file" .sgmodule)
              
              # æ£€æŸ¥æ˜¯å¦å­˜åœ¨åŒåçš„ .srmodule
              if [ -f "../../$TARGET_DIR/$filename.srmodule" ]; then
                echo "  â­ï¸ Skipped .sgmodule (srmodule exists): $file"
              else
                cp "$file" "../../$TARGET_DIR/"
                echo "  âœ… Copied .sgmodule: $file"
              fi
            done
            
            cd ../..
          else
            echo "âš ï¸ Directory Rewrite not found in iab0x00/ProxyRules"
          fi
          
          rm -rf temp_iab

      # === ä»»åŠ¡ 2: å¤„ç† LOWERTOP ===
      - name: Process LOWERTOP (Rename Logic)
        run: |
          AUTHOR="LOWERTOP"
          TARGET_DIR="Modules/Shadowrocket/$AUTHOR"
          mkdir -p "$TARGET_DIR"
          
          echo "ğŸš€ Cloning $AUTHOR..."
          git clone --depth 1 -b main https://github.com/LOWERTOP/Shadowrocket-First.git temp_lowertop
          
          cd temp_lowertop
          
          # æŸ¥æ‰¾ .sgmodule å¹¶é‡å‘½åä¸º .srmodule
          find . -maxdepth 1 -name "*.sgmodule" | while read file; do
            filename=$(basename "$file" .sgmodule)
            
            cp "$file" "../../$TARGET_DIR/$filename.srmodule"
            echo "  âœ… Renamed & Copied: $filename.sgmodule -> $filename.srmodule"
          done
          
          cd ..
          rm -rf temp_lowertop

      # === ä»»åŠ¡ 3: JS æ›¿æ¢ (ä»…é’ˆå¯¹è¿™ä¸¤ä¸ªä½œè€…) ===
      - name: Find and replace external JS resources
        continue-on-error: true
        run: |
          # å®šä¹‰ JS å­˜å‚¨çš„åŸºç¡€ URL
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"
          UA="Shadowrocket/2036"  # æ¨¡æ‹Ÿ Shadowrocket UA

          # å®šä¹‰è¦å¤„ç†çš„ä½œè€…åˆ—è¡¨
          AUTHORS=("iab0x00" "LOWERTOP")

          for author in "${AUTHORS[@]}"; do
            mkdir -p "Modules/JS/$author"
            echo "ğŸ” Scanning modules for $author..."
            
            # æ‰«æè¯¥ä½œè€…ç›®å½•ä¸‹çš„æ‰€æœ‰æ¨¡å—æ–‡ä»¶ (.srmodule æˆ– .sgmodule)
            find "Modules/Shadowrocket/$author" -type f \( -name "*.srmodule" -o -name "*.sgmodule" \) | while read module_file; do
              
              module_name=$(basename "$module_file")
              # å»æ‰åç¼€è·å–çº¯æ–‡ä»¶åï¼Œç”¨äºåˆ›å»º JS å­ç›®å½•
              module_folder="${module_name%.*}"
              
              # æå– http...js é“¾æ¥
              js_links=$(grep -v '#' "$module_file" | grep -oP 'https?://[^ \"\)]+\.(json|js|jq)' || echo "")

              if [ -z "$js_links" ]; then continue; fi
              
              echo "  Processing JS for $module_name"

              for js_link in $js_links; do
                js_filename=$(basename "$js_link")
                # è·¯å¾„ç»“æ„: Modules/JS/ä½œè€…/æ¨¡å—å/è„šæœ¬.js
                local_js_path="Modules/JS/$author/$module_folder/$js_filename"
                github_js_url="$js_base_url/$author/$module_folder/$js_filename"
                
                mkdir -p "$(dirname "$local_js_path")"

                # ä¸‹è½½ JS
                if curl -sL -A "$UA" --retry 2 --connect-timeout 10 -o "$local_js_path" "$js_link"; then
                  
                  escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
                  
                  # ä»…æ›¿æ¢å½“å‰æ–‡ä»¶
                  sed -i "s|$escaped_link|$github_js_url|g" "$module_file"
                  
                  echo "    âœ… Replaced $js_filename"
                else
                  echo "    âš ï¸ Failed to download JS: $js_link"
                fi
              done
            done
          done

      - name: Commit and push changes
        run: |
          DATE="$(date '+%Y-%m-%d %H:%M:%S')"
          git add Modules
          
          if git diff --cached --quiet; then
            echo "âœ… No changes to commit."
          else
            COMMIT_MESSAGE="Mirror Shadowrocket Modules at $DATE (UTC+8)"
            git commit -m "$COMMIT_MESSAGE"
            git pull --rebase --autostash || true
            git push
          fi
