name: Mirror Shadowrocket Modules

on:
  schedule:
    - cron: '0 2,14 * * *'  # æ¯å¤© 02:00 å’Œ 14:00 è¿è¡Œ (å¯è‡ªè¡Œè°ƒæ•´)
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      # === ä»»åŠ¡ 1: å¤„ç† iab0x00 (mainåˆ†æ”¯, Rewriteç›®å½•, .srmodule) ===
      - name: Mirror iab0x00
        run: |
          AUTHOR="iab0x00"
          mkdir -p "Modules/Shadowrocket/$AUTHOR"
          
          echo "ğŸš€ Cloning iab0x00/ProxyRules (main)..."
          # åªå…‹éš†æœ€æ–°ä¸€æ¬¡æäº¤ï¼Œé€Ÿåº¦æå¿«
          git clone --depth 1 -b main https://github.com/iab0x00/ProxyRules.git temp_iab
          
          if [ -d "temp_iab/Rewrite" ]; then
            echo "ğŸ“‚ Found Rewrite directory, copying .srmodule files..."
            # æŸ¥æ‰¾ Rewrite ç›®å½•ä¸‹çš„æ‰€æœ‰ .srmodule å¹¶å¤åˆ¶
            find temp_iab/Rewrite -name "*.srmodule" -exec cp {} "Modules/Shadowrocket/$AUTHOR/" \;
          else
            echo "âš ï¸ Rewrite directory not found!"
          fi
          
          rm -rf temp_iab

      # === ä»»åŠ¡ 2: å¤„ç† LOWERTOP (mainåˆ†æ”¯, æ ¹ç›®å½•, .sgmodule -> .srmodule) ===
      - name: Mirror LOWERTOP
        run: |
          AUTHOR="LOWERTOP"
          mkdir -p "Modules/Shadowrocket/$AUTHOR"
          
          echo "ğŸš€ Cloning LOWERTOP/Shadowrocket-First (main)..."
          git clone --depth 1 -b main https://github.com/LOWERTOP/Shadowrocket-First.git temp_lowertop
          
          echo "ğŸ”„ Renaming and Copying files..."
          # æŸ¥æ‰¾æ ¹ç›®å½•ä¸‹çš„ .sgmodule æ–‡ä»¶
          find temp_lowertop -maxdepth 1 -name "*.sgmodule" | while read file; do
            filename=$(basename "$file" .sgmodule)
            target_name="${filename}.srmodule"
            
            echo "  - $filename.sgmodule -> $target_name"
            cp "$file" "Modules/Shadowrocket/$AUTHOR/$target_name"
          done
          
          rm -rf temp_lowertop

      # === ä»»åŠ¡ 3: æ›¿æ¢ JS é“¾æ¥ ===
      - name: Find and replace external JS resources
        continue-on-error: true
        run: |
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"
          
          # ä»…éå†è¿™ä¸¤ä¸ªä½œè€…çš„ç›®å½•
          for author in iab0x00 LOWERTOP; do
            TARGET_DIR="Modules/Shadowrocket/$author"
            
            if [ ! -d "$TARGET_DIR" ]; then continue; fi
            
            echo "ğŸ” Scanning JS links for $author..."
            mkdir -p "Modules/JS/$author"

            # éå† .srmodule æ–‡ä»¶
            find "$TARGET_DIR" -name "*.srmodule" | while read module_file; do
              module_folder=$(basename "$module_file" .srmodule)
              
              # æå– http/https å¼€å¤´çš„ .js/.json/.jq é“¾æ¥
              js_links=$(grep -v '#' "$module_file" | grep -oP 'https?://[^ \"\)]+\.(json|js|jq)' || echo "")
              
              if [ -z "$js_links" ]; then continue; fi
              
              echo "  Processing: $module_folder"

              for js_link in $js_links; do
                js_filename=$(basename "$js_link")
                local_js_path="Modules/JS/$author/$module_folder/$js_filename"
                github_js_url="$js_base_url/$author/$module_folder/$js_filename"
                
                mkdir -p "$(dirname "$local_js_path")"
                
                # ä¸‹è½½ JS (ä½¿ç”¨ Shadowrocket UA)
                if curl -sL -A "Shadowrocket/2.2.53" --retry 2 --connect-timeout 10 -o "$local_js_path" "$js_link"; then
                   # æ›¿æ¢æ–‡ä»¶ä¸­çš„é“¾æ¥
                   escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
                   sed -i "s|$escaped_link|$github_js_url|g" "$module_file"
                   echo "    âœ… Replaced $js_filename"
                else
                   echo "    âš ï¸ Failed to download $js_link"
                fi
              done
            done
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          
          git add Modules/*
          
          if git diff --cached --quiet; then
            echo "âœ… No changes to commit."
          else
            COMMIT_MESSAGE="Mirrored Shadowrocket Modules at $DATE (UTC+8)"
            git commit -m "$COMMIT_MESSAGE"
            git pull --rebase --autostash || true
            git push
          fi
