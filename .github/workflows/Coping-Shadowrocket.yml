name: Mirror Shadowrocket Specific Modules

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œä¸€æ¬¡ (å¯è‡ªè¡Œè°ƒæ•´)
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  mirror-shadowrocket:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      # === 1. å¤„ç† iab0x00 (ç›´æ¥å¤åˆ¶ .srmodule) ===
      - name: Process iab0x00/ProxyRules
        run: |
          AUTHOR="iab0x00"
          TARGET_DIR="Modules/Shadowrocket/$AUTHOR"
          mkdir -p "$TARGET_DIR"
          
          # å…‹éš†ä»“åº“
          git clone --depth 1 https://github.com/iab0x00/ProxyRules.git temp_iab
          
          # å¤åˆ¶ Rewrite ç›®å½•ä¸‹çš„ .srmodule æ–‡ä»¶
          if [ -d "temp_iab/Rewrite" ]; then
            # æŸ¥æ‰¾å¹¶å¤åˆ¶ï¼Œé¿å… cp æ²¡æœ‰æ–‡ä»¶æ—¶æŠ¥é”™
            find temp_iab/Rewrite -name "*.srmodule" -exec cp {} "$TARGET_DIR/" \;
            echo "âœ… iab0x00 files copied."
          else
            echo "âš ï¸ Directory Rewrite not found in iab0x00/ProxyRules"
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf temp_iab

      # === 2. å¤„ç† LOWERTOP (sgmodule -> srmodule) ===
      - name: Process LOWERTOP/Shadowrocket-First
        run: |
          AUTHOR="LOWERTOP"
          TARGET_DIR="Modules/Shadowrocket/$AUTHOR"
          mkdir -p "$TARGET_DIR"
          
          # å…‹éš†ä»“åº“
          git clone --depth 1 https://github.com/LOWERTOP/Shadowrocket-First.git temp_lowertop
          
          # æŸ¥æ‰¾ .sgmodule å¹¶é‡å‘½åå¤åˆ¶
          # find å‘½ä»¤æŸ¥æ‰¾æ‰€æœ‰ .sgmodule
          find temp_lowertop -name "*.sgmodule" | while read file; do
            filename=$(basename "$file" .sgmodule)
            # å¤åˆ¶å¹¶æ”¹åç¼€ä¸º .srmodule
            cp "$file" "$TARGET_DIR/${filename}.srmodule"
            echo "âœ… Copied & Renamed: ${filename}.sgmodule -> ${filename}.srmodule"
          done
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf temp_lowertop

      # === 3. JS èµ„æºæå–ä¸æ›¿æ¢ ===
      - name: Find and replace external JS resources
        continue-on-error: true
        run: |
          js_base_url="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/Modules/JS"
          UA="Shadowrocket/1982" # ä¼ªè£…æˆ Shadowrocket

          # å®šä¹‰éœ€è¦å¤„ç†çš„ä½œè€…åˆ—è¡¨
          AUTHORS=("iab0x00" "LOWERTOP")

          for author in "${AUTHORS[@]}"; do
            SEARCH_DIR="Modules/Shadowrocket/$author"
            JS_SAVE_DIR="Modules/JS/$author"
            
            echo "ğŸ” Scanning directory: $SEARCH_DIR"
            
            if [ ! -d "$SEARCH_DIR" ]; then
              echo "âš ï¸ Directory $SEARCH_DIR does not exist, skipping."
              continue
            fi

            # éå†è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰ .srmodule æ–‡ä»¶
            find "$SEARCH_DIR" -name "*.srmodule" | while read module_file; do
              module_name=$(basename "$module_file" .srmodule)
              
              # æå– JS é“¾æ¥ (http å¼€å¤´ï¼Œä»¥ .js .json .jq ç»“å°¾)
              js_links=$(grep -v '#' "$module_file" | grep -oP 'https?://[^ \"\)]+\.(json|js|jq)' || echo "")

              if [ -z "$js_links" ]; then continue; fi
              
              echo "  Processing JS for $module_name"

              for js_link in $js_links; do
                js_filename=$(basename "$js_link")
                # ä¸ºäº†é˜²æ­¢ä¸åŒæ¨¡å—åŒå JS å†²çªï¼Œå»ºè®®åŠ ä¸€å±‚æ¨¡å—åæ–‡ä»¶å¤¹ï¼Œæˆ–è€…ç›´æ¥æ”¾ä½œè€…ç›®å½•ä¸‹(è§†ä½ çš„ä¹ æƒ¯è€Œå®š)
                # è¿™é‡Œä¿æŒå’Œä½ ä¹‹å‰ä¸€è‡´ï¼šModules/JS/ä½œè€…/æ¨¡å—å/è„šæœ¬.js
                local_js_path="$JS_SAVE_DIR/$module_name/$js_filename"
                github_js_url="$js_base_url/$author/$module_name/$js_filename"
                
                mkdir -p "$(dirname "$local_js_path")"

                # ä¸‹è½½ JS
                if curl -sL -A "$UA" --retry 2 --connect-timeout 10 -o "$local_js_path" "$js_link"; then
                  # è½¬ä¹‰é“¾æ¥å­—ç¬¦
                  escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
                  
                  # æ›¿æ¢æ–‡ä»¶ä¸­çš„é“¾æ¥
                  sed -i "s|$escaped_link|$github_js_url|g" "$module_file"
                  
                  echo "    âœ… Replaced $js_filename"
                else
                  echo "    âš ï¸ Failed to download JS: $js_link"
                fi
              done
            done
          done

      - name: Commit and push changes
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          
          git add Modules
          
          if git diff --cached --quiet; then
            echo "âœ… No changes to commit."
          else
            COMMIT_MESSAGE="Update Shadowrocket Modules at $DATE (UTC+8)"
            git commit -m "$COMMIT_MESSAGE"
            git pull --rebase --autostash || true
            git push
          fi
