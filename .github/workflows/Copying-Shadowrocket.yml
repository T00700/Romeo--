name: Mirror Specific Shadowrocket Modules

on:
  schedule:
    - cron: '0 20 * * *'  # æ¯å¤©æ‰§è¡Œä¸€æ¬¡ï¼Œæ—¶é—´å¯è‡ªè¡Œè°ƒæ•´
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  mirror-shadowrocket:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      # === ä»»åŠ¡ 1: å¤„ç† iab0x00 ===
      # é€»è¾‘ï¼šä¼˜å…ˆ .srmoduleï¼Œæ— åˆ™å– .sgmodule å¹¶æ”¹å
      - name: Process iab0x00 (ProxyRules)
        run: |
          AUTHOR="iab0x00"
          TARGET_DIR="Modules/Shadowrocket/$AUTHOR"
          mkdir -p "$TARGET_DIR"
          
          echo "ğŸš€ Cloning $AUTHOR/ProxyRules..."
          git clone --depth 1 -b main https://github.com/iab0x00/ProxyRules.git temp_iab
          
          # è¿›å…¥ Rewrite ç›®å½•å¤„ç†
          if [ -d "temp_iab/Rewrite" ]; then
            cd temp_iab/Rewrite
            
            # è·å–æ‰€æœ‰æ— åç¼€çš„æ–‡ä»¶ååˆ—è¡¨ (å»é‡)
            # æŸ¥æ‰¾ .sgmodule å’Œ .srmoduleï¼Œå»æ‰åç¼€ï¼Œæ’åºå»é‡
            find . -maxdepth 1 -type f \( -name "*.sgmodule" -o -name "*.srmodule" \) | sed 's/\.[^.]*$//' | sort -u | while read basename_path; do
              basename=$(basename "$basename_path")
              
              # ä¼˜å…ˆçº§åˆ¤æ–­é€»è¾‘
              if [ -f "${basename}.srmodule" ]; then
                echo "  âœ… Found .srmodule: ${basename}.srmodule"
                cp "${basename}.srmodule" "../../$TARGET_DIR/${basename}.srmodule"
              elif [ -f "${basename}.sgmodule" ]; then
                echo "  ğŸ”„ Found .sgmodule, renaming: ${basename}.sgmodule -> .srmodule"
                cp "${basename}.sgmodule" "../../$TARGET_DIR/${basename}.srmodule"
              fi
            done
            cd ../..
          else
            echo "âš ï¸ Rewrite directory not found in iab0x00/ProxyRules"
          fi
          
          rm -rf temp_iab

      # === ä»»åŠ¡ 2: å¤„ç† LOWERTOP ===
      # é€»è¾‘ï¼šä¸‹è½½ .sgmodule -> é‡å‘½åä¸º .srmodule
      - name: Process LOWERTOP (Shadowrocket-First)
        run: |
          AUTHOR="LOWERTOP"
          TARGET_DIR="Modules/Shadowrocket/$AUTHOR"
          mkdir -p "$TARGET_DIR"
          
          echo "ğŸš€ Cloning $AUTHOR/Shadowrocket-First..."
          git clone --depth 1 -b main https://github.com/LOWERTOP/Shadowrocket-First.git temp_lowertop
          
          # æŸ¥æ‰¾æ ¹ç›®å½•ä¸‹çš„ sgmodule å¹¶æ”¹åå¤åˆ¶
          find temp_lowertop -maxdepth 1 -type f -name "*.sgmodule" | while read file; do
            filename=$(basename "$file" .sgmodule)
            echo "  ğŸ”„ Converting: $filename.sgmodule -> .srmodule"
            cp "$file" "$TARGET_DIR/$filename.srmodule"
          done
          
          rm -rf temp_lowertop

      # === ä»»åŠ¡ 3: ç»Ÿä¸€æ›¿æ¢ JS é“¾æ¥ ===
      - name: Find and replace external JS resources
        continue-on-error: true
        run: |
          # è®¾ç½®åŸºç¡€ URL
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"
          
          # å®šä¹‰éœ€è¦æ‰«æçš„ä½œè€…ç›®å½•
          AUTHORS=("iab0x00" "LOWERTOP")
          
          for author in "${AUTHORS[@]}"; do
            echo "ğŸ” Scanning JS for author: $author"
            mkdir -p "Modules/JS/$author"
            
            # æ‰«æè¯¥ä½œè€…ç›®å½•ä¸‹çš„æ‰€æœ‰ .srmodule æ–‡ä»¶
            find "Modules/Shadowrocket/$author" -name "*.srmodule" | while read module_file; do
              module_folder=$(basename "$module_file" .srmodule)
              
              # æå– JS é“¾æ¥ (å…¼å®¹ json/js/jq)
              js_links=$(grep -v '#' "$module_file" | grep -oP 'https?://[^ \"\)]+\.(json|js|jq)' || echo "")
              
              if [ -z "$js_links" ]; then continue; fi
              
              echo "  Processing JS in: $module_folder"
              
              for js_link in $js_links; do
                js_filename=$(basename "$js_link")
                # JS ä¿å­˜è·¯å¾„
                local_js_path="Modules/JS/$author/$module_folder/$js_filename"
                # è¿™é‡Œçš„ GitHub Raw åœ°å€
                github_js_url="$js_base_url/$author/$module_folder/$js_filename"
                
                mkdir -p "$(dirname "$local_js_path")"
                
                # ä¸‹è½½ JS
                if curl -sL -A "Surge Mac/2985" --connect-timeout 10 --retry 2 -o "$local_js_path" "$js_link"; then
                  # è½¬ä¹‰é“¾æ¥ç”¨äº sed
                  escaped_link=$(printf '%s' "$js_link" | sed 's/[.[\*^$(){}+?|]/\\&/g')
                  
                  # æ›¿æ¢æ–‡ä»¶ä¸­çš„é“¾æ¥
                  sed -i "s|$escaped_link|$github_js_url|g" "$module_file"
                  echo "    âœ… Replaced: $js_filename"
                else
                  echo "    âš ï¸ Failed to download: $js_link"
                fi
              done
            done
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          
          git add Modules/*
          
          if git diff --cached --quiet; then
            echo "âœ… No changes to commit."
          else
            COMMIT_MESSAGE="Mirror Shadowrocket Modules at $DATE (UTC+8)"
            
            git commit -m "$COMMIT_MESSAGE"
            git pull --rebase --autostash || true
            git push
          fi
